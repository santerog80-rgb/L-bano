<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1A1209">
<title>Luvano - Marketplace de Mo√ßambique</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --terra:#C4622D; --terra-dark:#B5551F; --terra-light:#F9EDE5;
  --gold:#E8A838; --gold-light:#FEF3DC;
  --deep:#1A1209; --deep2:#2D1A0A;
  --forest:#2D5A27;
  --sand:#F5EDD8; --cream:#FDFAF4;
  --muted:#8B7355; --muted2:#B8A48C;
  --border:#E8DCC8; --border2:#F0E6D2;
  --white:#FFFFFF;
  --radius:14px; --radius-sm:10px; --radius-lg:20px;
  --shadow-sm:0 2px 8px rgba(26,18,9,0.08);
  --shadow:0 6px 24px rgba(26,18,9,0.12);
  --shadow-lg:0 16px 48px rgba(26,18,9,0.18);
  --nav-h:60px; --bottom-nav-h:68px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--deep);min-height:100vh;overflow-x:hidden;}
button,input,textarea,select{font-family:inherit;}
img{display:block;max-width:100%;}
a{text-decoration:none;color:inherit;}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* ===== LOADER ===== */
#loader{position:fixed;inset:0;background:var(--deep);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;z-index:9999;transition:opacity .5s;}
#loader.hide{opacity:0;pointer-events:none;}
.loader-logo{font-family:'Syne',sans-serif;font-size:2.8rem;font-weight:800;color:var(--gold);letter-spacing:-2px;}
.loader-tag{color:rgba(255,255,255,.4);font-size:.82rem;letter-spacing:3px;text-transform:uppercase;}
.loader-track{width:180px;height:3px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;margin-top:6px;}
.loader-bar{height:100%;background:linear-gradient(90deg,var(--gold),var(--terra));animation:loadBar 1.6s ease forwards;}
@keyframes loadBar{from{width:0}to{width:100%}}

/* ===== PAGES ===== */
.page{display:none;min-height:calc(100vh - var(--nav-h));}
.page.active{display:block;animation:fadeUp .25s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ===== TOAST ===== */
#toast{position:fixed;bottom:calc(var(--bottom-nav-h) + 12px);left:50%;transform:translateX(-50%) translateY(20px);background:var(--deep);color:#fff;padding:12px 20px;border-radius:40px;font-size:.88rem;font-weight:500;white-space:nowrap;z-index:9998;opacity:0;transition:all .3s;pointer-events:none;box-shadow:var(--shadow-lg);}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
#toast.success{background:var(--forest);}
#toast.error{background:#C0392B;}
#toast.info{background:var(--deep2);}

/* ===== AUTH ‚Äî MOBILE FIRST ===== */
#auth-page{display:none;min-height:100vh;background:var(--deep);position:relative;overflow-x:hidden;}
#auth-page.active{display:block;}

/* Animated background */
.auth-bg{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.auth-bg-grad{position:absolute;inset:0;background:linear-gradient(160deg,#2D1A0A 0%,#1A1209 50%,#0F2418 100%);}
.auth-bg-circle1{position:absolute;top:-120px;right:-80px;width:340px;height:340px;border-radius:50%;background:radial-gradient(circle,rgba(232,168,56,.18) 0%,transparent 65%);}
.auth-bg-circle2{position:absolute;bottom:-100px;left:-60px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(196,98,45,.14) 0%,transparent 65%);}
.auth-bg-dots{position:absolute;inset:0;opacity:.035;background-image:radial-gradient(var(--gold) 1px,transparent 1px);background-size:24px 24px;}

/* === MOBILE LAYOUT (default ‚Äî mobile first) === */
.auth-wrap{position:relative;z-index:2;display:flex;flex-direction:column;min-height:100vh;}

/* Top hero section (mobile) */
.auth-hero{
  flex-shrink:0;
  padding:48px 24px 36px;
  display:flex;flex-direction:column;align-items:center;text-align:center;
  position:relative;
}
.auth-logo{font-family:'Syne',sans-serif;font-size:3.2rem;font-weight:800;color:var(--gold);letter-spacing:-3px;line-height:1;margin-bottom:6px;}
.auth-logo-flag{font-size:1.4rem;margin-bottom:10px;}
.auth-tagline{color:rgba(255,255,255,.5);font-size:.82rem;letter-spacing:1px;margin-bottom:24px;}
/* mini features row (mobile) */
.auth-pills{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:340px;}
.auth-pill{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:5px 12px;font-size:.72rem;color:rgba(255,255,255,.65);white-space:nowrap;display:flex;align-items:center;gap:5px;}

/* Form card ‚Äî slides up from bottom on mobile */
.auth-card{
  flex:1;background:var(--cream);
  border-radius:28px 28px 0 0;
  padding:28px 20px 40px;
  box-shadow:0 -8px 40px rgba(0,0,0,.3);
  animation:slideUp .35s ease;
  min-height:0;
}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}

/* Tab switcher */
.auth-tabs{
  display:flex;background:var(--sand);border-radius:14px;padding:4px;margin-bottom:24px;
  box-shadow:inset 0 1px 3px rgba(0,0,0,.06);
}
.auth-tab{
  flex:1;padding:11px 8px;text-align:center;border-radius:10px;cursor:pointer;
  font-weight:700;font-size:.9rem;transition:all .22s;color:var(--muted);
  -webkit-tap-highlight-color:transparent;
}
.auth-tab.active{background:var(--deep);color:var(--gold);box-shadow:0 2px 8px rgba(0,0,0,.2);}

/* Form headings */
.form-h{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;margin-bottom:3px;letter-spacing:-.5px;}
.form-sub{color:var(--muted);font-size:.86rem;margin-bottom:20px;line-height:1.5;}

/* Field groups */
.fgroup{margin-bottom:14px;position:relative;}
.flabel{font-size:.75rem;font-weight:700;color:var(--deep);margin-bottom:6px;display:block;letter-spacing:.4px;text-transform:uppercase;}

/* Inputs ‚Äî bigger touch targets on mobile */
.finput{
  width:100%;padding:14px 15px;
  border:2px solid var(--border);border-radius:12px;
  font-size:1rem;/* prevent iOS zoom ‚Äî must be 16px+ */
  background:#fff;color:var(--deep);outline:none;
  transition:all .2s;-webkit-appearance:none;
  -webkit-text-size-adjust:100%;
}
.finput:focus{border-color:var(--terra);box-shadow:0 0 0 4px rgba(196,98,45,.1);}
.finput::placeholder{color:var(--muted2);}

/* Password field with show/hide */
.pass-wrap{position:relative;}
.pass-wrap .finput{padding-right:48px;}
.pass-eye{
  position:absolute;right:14px;top:50%;transform:translateY(-50%);
  background:none;border:none;cursor:pointer;font-size:1.1rem;
  color:var(--muted);padding:4px;line-height:1;
  -webkit-tap-highlight-color:transparent;
}

/* Two-col row ‚Äî single col on very small screens */
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:360px){.frow{grid-template-columns:1fr;}}

/* Submit button */
.btn-main{
  width:100%;padding:15px;background:var(--terra);color:#fff;border:none;
  border-radius:12px;font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;
  cursor:pointer;transition:all .2s;letter-spacing:.3px;
  -webkit-tap-highlight-color:transparent;
  margin-top:4px;
}
.btn-main:active{transform:scale(.97);background:var(--terra-dark);}
.btn-main:disabled{background:var(--muted2);cursor:not-allowed;}

/* Progress dots for register (step indicator) */
.reg-steps{display:flex;align-items:center;gap:6px;margin-bottom:20px;}
.reg-step{flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .3s;}
.reg-step.done{background:var(--terra);}
.reg-step.active{background:var(--gold);}

/* Error / success alerts */
.auth-err{
  background:#FEE2E2;border:1px solid #FECACA;color:#DC2626;
  padding:11px 14px;border-radius:10px;font-size:.84rem;
  margin-bottom:14px;display:none;
  display:flex;align-items:flex-start;gap:8px;
}
.auth-err.show{display:flex;}
.auth-err::before{content:'‚ö†Ô∏è';font-size:.9rem;flex-shrink:0;}

.auth-note{font-size:.73rem;color:var(--muted);text-align:center;margin-top:16px;line-height:1.6;}
.auth-note a{color:var(--terra);font-weight:600;}

/* Divider */
.auth-divider{display:flex;align-items:center;gap:10px;margin:18px 0;color:var(--muted2);font-size:.78rem;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* === OTP VERIFICATION === */
.otp-wrap{display:none;flex-direction:column;align-items:center;text-align:center;}
.otp-wrap.active{display:flex;}
.otp-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--gold-light),var(--terra-light));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin-bottom:20px;box-shadow:0 8px 24px rgba(196,98,45,.2);}
.otp-title{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;margin-bottom:6px;}
.otp-sub{color:var(--muted);font-size:.88rem;line-height:1.6;margin-bottom:28px;max-width:320px;}
.otp-email{color:var(--terra);font-weight:700;}
.otp-inputs{display:flex;gap:8px;justify-content:center;margin-bottom:20px;}
.otp-input{width:48px;height:56px;border:2px solid var(--border);border-radius:12px;text-align:center;font-size:1.5rem;font-weight:700;font-family:'Syne',sans-serif;color:var(--deep);background:#fff;outline:none;transition:all .2s;caret-color:var(--terra);}
.otp-input:focus{border-color:var(--terra);box-shadow:0 0 0 4px rgba(196,98,45,.1);transform:scale(1.05);}
.otp-input.filled{border-color:var(--terra);background:var(--terra-light);}
.otp-input.error{border-color:#DC2626;animation:shake .4s;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.otp-timer{font-size:.82rem;color:var(--muted);margin-bottom:16px;}
.otp-timer.active{color:var(--terra);font-weight:600;}
.otp-resend{background:transparent;border:none;color:var(--terra);font-weight:700;font-size:.88rem;cursor:pointer;padding:8px 16px;border-radius:8px;transition:all .2s;}
.otp-resend:hover{background:var(--terra-light);}
.otp-resend:disabled{color:var(--muted2);cursor:not-allowed;}
.otp-back{display:inline-flex;align-items:center;gap:6px;color:var(--muted);font-size:.85rem;margin-top:20px;cursor:pointer;transition:color .2s;}
.otp-back:hover{color:var(--terra);}

/* === DESKTOP LAYOUT (‚â• 900px) === */
@media(min-width:900px){
  .auth-wrap{flex-direction:row;min-height:100vh;}

  /* Hide mobile hero, show desktop left panel */
  .auth-hero{display:none;}
  .auth-left-desk{
    flex:1;display:flex!important;flex-direction:column;
    align-items:center;justify-content:center;
    padding:60px 48px;gap:32px;
  }
  .auth-desk-logo{font-family:'Syne',sans-serif;font-size:4rem;font-weight:800;color:var(--gold);letter-spacing:-3px;line-height:1;}
  .auth-desk-tag{color:rgba(255,255,255,.45);font-size:.95rem;margin-top:6px;letter-spacing:1px;}
  .auth-feats-desk{display:flex!important;flex-direction:column;gap:18px;max-width:300px;width:100%;}
  .auth-feat-desk{display:flex;align-items:center;gap:14px;color:rgba(255,255,255,.72);}
  .auth-feat-icon{width:44px;height:44px;border-radius:12px;background:rgba(232,168,56,.12);border:1px solid rgba(232,168,56,.25);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
  .auth-feat-txt{font-size:.88rem;line-height:1.5;}

  /* Right panel as a column */
  .auth-card-wrap{
    width:480px;flex-shrink:0;
    background:var(--cream);display:flex;
    align-items:center;justify-content:center;
    padding:48px 44px;min-height:100vh;
  }
  .auth-card{
    flex:none;background:transparent;box-shadow:none;
    border-radius:0;padding:0;animation:none;
    width:100%;max-width:380px;
  }
  .frow{grid-template-columns:1fr 1fr;}
  .finput{font-size:.95rem;padding:13px 15px;}
  .btn-main{padding:14px;}
  .otp-input{width:52px;height:60px;}
}

/* ===== NAVBAR (desktop) ===== */
.navbar{position:sticky;top:0;z-index:200;background:var(--deep);height:var(--nav-h);display:flex;align-items:center;gap:14px;padding:0 20px;border-bottom:1px solid rgba(255,255,255,.06);}
.nav-logo{font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;color:var(--gold);letter-spacing:-1px;cursor:pointer;flex-shrink:0;}
.nav-search{flex:1;max-width:480px;position:relative;}
.nav-search input{width:100%;padding:9px 14px 9px 40px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:.88rem;outline:none;transition:all .2s;}
.nav-search input::placeholder{color:rgba(255,255,255,.3);}
.nav-search input:focus{background:rgba(255,255,255,.13);border-color:var(--gold);}
.nav-search-ic{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.35);font-size:.9rem;pointer-events:none;}
.nav-actions{display:flex;align-items:center;gap:8px;margin-left:auto;}
.nav-btn-sell{padding:9px 18px;background:var(--terra);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:.85rem;cursor:pointer;transition:all .2s;white-space:nowrap;}
.nav-btn-sell:hover{background:var(--terra-dark);}
.nav-chat-btn{position:relative;width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.1);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#fff;transition:all .2s;}
.nav-chat-btn:hover{background:rgba(255,255,255,.18);}
.nav-badge{position:absolute;top:-2px;right:-2px;width:18px;height:18px;background:var(--terra);border-radius:50%;font-size:.65rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid var(--deep);display:none;}
.nav-badge.show{display:flex;}
.nav-av-wrap{position:relative;}
.nav-av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--terra),var(--gold));display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;font-size:.9rem;color:var(--deep);}
.dropdown{position:absolute;top:calc(100%+10px);right:0;background:#fff;border-radius:14px;box-shadow:var(--shadow-lg);border:1px solid var(--border);min-width:190px;overflow:hidden;display:none;z-index:300;}
.dropdown.open{display:block;animation:fadeUp .15s ease;}
.dd-item{padding:12px 16px;cursor:pointer;font-size:.88rem;display:flex;align-items:center;gap:10px;transition:background .15s;}
.dd-item:hover{background:var(--sand);}
.dd-item.red{color:#DC2626;}
.dd-sep{height:1px;background:var(--border);}

/* ===== CATEGORIES BAR ===== */
.cats-bar{background:#fff;border-bottom:1px solid var(--border);padding:0 16px;height:50px;display:flex;align-items:center;gap:4px;overflow-x:auto;scrollbar-width:none;}
.cats-bar::-webkit-scrollbar{display:none;}
.cat-chip{flex-shrink:0;padding:6px 14px;border-radius:20px;border:1.5px solid var(--border);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;color:var(--muted);white-space:nowrap;display:flex;align-items:center;gap:5px;}
.cat-chip:hover,.cat-chip.active{background:var(--terra);color:#fff;border-color:var(--terra);}

/* ===== BOTTOM NAV (mobile) ===== */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;background:var(--deep);border-top:1px solid rgba(255,255,255,.08);height:var(--bottom-nav-h);padding:0 4px 8px;}
.bn-list{display:flex;height:100%;align-items:center;}
.bn-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;padding:8px 4px;border-radius:12px;transition:all .2s;position:relative;}
.bn-item.active .bn-icon,.bn-item.active .bn-label{color:var(--gold);}
.bn-icon{font-size:1.3rem;color:rgba(255,255,255,.45);transition:color .2s;}
.bn-label{font-size:.65rem;color:rgba(255,255,255,.4);font-weight:600;letter-spacing:.3px;transition:color .2s;}
.bn-badge{position:absolute;top:6px;right:calc(50% - 18px);width:16px;height:16px;background:var(--terra);border-radius:50%;font-size:.6rem;font-weight:700;color:#fff;display:none;align-items:center;justify-content:center;border:2px solid var(--deep);}
.bn-badge.show{display:flex;}
/* sell fab */
.bn-fab{width:52px;height:52px;border-radius:50%;background:var(--terra);border:3px solid var(--deep);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff;margin-top:-10px;box-shadow:var(--shadow);}

/* ===== HOME ===== */
.hero{background:linear-gradient(135deg,var(--deep) 0%,var(--deep2) 100%);padding:36px 20px;position:relative;overflow:hidden;}
.hero::after{content:'';position:absolute;right:-80px;top:-80px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(232,168,56,.18) 0%,transparent 70%);}
.hero-in{position:relative;z-index:1;max-width:600px;}
.hero-badge{display:inline-flex;align-items:center;gap:7px;background:rgba(232,168,56,.12);border:1px solid rgba(232,168,56,.25);padding:5px 13px;border-radius:20px;color:var(--gold);font-size:.75rem;font-weight:700;margin-bottom:16px;letter-spacing:.8px;text-transform:uppercase;}
.hero-title{font-family:'Syne',sans-serif;font-size:2.4rem;font-weight:800;color:#fff;line-height:1.1;letter-spacing:-1.5px;margin-bottom:12px;}
.hero-title span{color:var(--gold);}
.hero-desc{color:rgba(255,255,255,.55);font-size:.92rem;margin-bottom:24px;line-height:1.6;max-width:460px;}
.hero-stats{display:flex;gap:28px;flex-wrap:wrap;}
.h-stat .num{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;color:var(--gold);}
.h-stat .lbl{font-size:.72rem;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.8px;}
.content{max-width:1280px;margin:0 auto;padding:28px 16px;}
.sec-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.sec-title{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;}
.sec-link{font-size:.84rem;color:var(--terra);font-weight:600;cursor:pointer;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}

/* ===== PRODUCT CARD ===== */
.pcard{background:#fff;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:all .22s;position:relative;}
.pcard:active{transform:scale(.98);}
@media(hover:hover){.pcard:hover{transform:translateY(-4px);box-shadow:var(--shadow);}}
.pcard-img{position:relative;aspect-ratio:4/3;overflow:hidden;background:var(--sand);}
.pcard-img img{width:100%;height:100%;object-fit:cover;transition:transform .4s;}
@media(hover:hover){.pcard:hover .pcard-img img{transform:scale(1.06);}}
.pcard-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2.8rem;}
.pcard-badge{position:absolute;top:8px;left:8px;background:var(--terra);color:#fff;font-size:.68rem;font-weight:700;padding:3px 9px;border-radius:6px;text-transform:uppercase;letter-spacing:.4px;}
.pcard-fav{position:absolute;top:8px;right:8px;width:30px;height:30px;background:rgba(255,255,255,.9);border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all .2s;backdrop-filter:blur(4px);}
.pcard-fav.on{color:#E53E3E;}
.pcard-body{padding:12px 14px;}
.pcard-title{font-weight:600;font-size:.88rem;line-height:1.4;margin-bottom:5px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.pcard-price{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:700;color:var(--terra);margin-bottom:7px;}
.pcard-foot{display:flex;align-items:center;justify-content:space-between;}
.pcard-loc{font-size:.72rem;color:var(--muted);display:flex;align-items:center;gap:3px;}
.pcard-stars{display:flex;align-items:center;gap:2px;font-size:.72rem;}
.star-on{color:var(--gold);}
.star-off{color:var(--border);}
.pcard-rc{color:var(--muted2);font-size:.7rem;}
.no-items{text-align:center;padding:60px 20px;grid-column:1/-1;}
.no-items .ni-icon{font-size:3.5rem;margin-bottom:12px;opacity:.5;}
.no-items h3{font-family:'Syne',sans-serif;font-size:1.2rem;margin-bottom:6px;}
.no-items p{color:var(--muted);font-size:.88rem;}

/* ===== DETAIL PAGE ===== */
.detail-wrap{max-width:1060px;margin:0 auto;padding:24px 16px;padding-bottom:calc(var(--bottom-nav-h) + 16px);}
.back-btn{display:inline-flex;align-items:center;gap:7px;color:var(--muted);font-size:.88rem;cursor:pointer;margin-bottom:20px;font-weight:500;transition:color .2s;padding:8px 0;}
.back-btn:hover{color:var(--terra);}
.detail-grid{display:grid;grid-template-columns:1fr 360px;gap:36px;}
/* images */
.det-imgs{}
.det-main{aspect-ratio:4/3;border-radius:var(--radius);overflow:hidden;background:var(--sand);margin-bottom:10px;}
.det-main img,.det-main .ph{width:100%;height:100%;object-fit:cover;}
.det-main .ph{display:flex;align-items:center;justify-content:center;font-size:5rem;}
.thumbs{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;}
.thumbs::-webkit-scrollbar{display:none;}
.thumb{width:72px;height:58px;border-radius:8px;overflow:hidden;cursor:pointer;border:2.5px solid transparent;flex-shrink:0;transition:all .2s;}
.thumb.on{border-color:var(--terra);}
.thumb img{width:100%;height:100%;object-fit:cover;}
/* info panel */
.det-info{}
.det-cat{font-size:.72rem;font-weight:700;color:var(--terra);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;}
.det-title{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;line-height:1.2;margin-bottom:12px;}
.det-price-row{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
.det-price{font-family:'Syne',sans-serif;font-size:1.9rem;font-weight:800;color:var(--terra);}
.curr-sel{padding:8px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:.82rem;outline:none;background:#fff;cursor:pointer;-webkit-appearance:none;}
.det-rating{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--border);}
.stars-lg{display:flex;gap:3px;font-size:1.15rem;}
.det-loc{display:flex;align-items:center;gap:7px;color:var(--muted);font-size:.88rem;margin-bottom:12px;}
.det-desc{font-size:.91rem;line-height:1.7;color:#444;margin-bottom:18px;}
.seller-box{background:var(--sand);border-radius:var(--radius-sm);padding:14px;margin-bottom:16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s;}
.seller-box:hover{background:var(--border2);}
.seller-av{width:46px;height:46px;border-radius:50%;background:var(--terra);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.1rem;flex-shrink:0;}
.seller-nm{font-weight:700;font-size:.92rem;margin-bottom:2px;}
.seller-info{font-size:.75rem;color:var(--muted);}
.det-actions{display:flex;flex-direction:column;gap:10px;}
.btn-wa{padding:14px;background:#25D366;color:#fff;border:none;border-radius:var(--radius-sm);font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;transition:all .2s;}
.btn-wa:hover{background:#1db954;}
.btn-wa:active{transform:scale(.98);}
.btn-chat{padding:13px;background:var(--terra-light);color:var(--terra);border:2px solid var(--terra);border-radius:var(--radius-sm);font-family:'Syne',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;transition:all .2s;}
.btn-chat:hover{background:var(--terra);color:#fff;}
.btn-share{padding:12px;background:transparent;color:var(--muted);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.88rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;}
.btn-share:hover{border-color:var(--terra);color:var(--terra);}
/* reviews section */
.reviews-sec{margin-top:40px;padding-top:28px;border-top:1px solid var(--border);}
.rev-title{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;margin-bottom:20px;}
.rate-box{background:var(--sand);border-radius:var(--radius-sm);padding:18px;margin-bottom:24px;}
.rate-lbl{font-weight:700;font-size:.8rem;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;}
.star-btns{display:flex;gap:5px;margin-bottom:12px;}
.sbtn{font-size:1.5rem;cursor:pointer;transition:transform .15s;color:var(--border);}
.sbtn.on{color:var(--gold);}
.sbtn:hover{transform:scale(1.15);}
.rev-list{display:flex;flex-direction:column;gap:14px;}
.rev-item{background:#fff;border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border);}
.rev-hd{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.rev-av{width:34px;height:34px;border-radius:50%;background:var(--forest);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.82rem;flex-shrink:0;}
.rev-nm{font-weight:600;font-size:.85rem;}
.rev-date{font-size:.72rem;color:var(--muted);}
.rev-txt{font-size:.86rem;color:#555;line-height:1.6;}
.rev-stars{display:flex;gap:2px;font-size:.85rem;}

/* ===== CREATE PAGE ===== */
.create-wrap{max-width:720px;margin:0 auto;padding:24px 16px;padding-bottom:calc(var(--bottom-nav-h) + 20px);}
.pg-title{font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800;margin-bottom:4px;}
.pg-sub{color:var(--muted);font-size:.9rem;margin-bottom:28px;}
.fsec{background:#fff;border-radius:var(--radius);border:1px solid var(--border);padding:20px;margin-bottom:16px;}
.fsec-title{font-family:'Syne',sans-serif;font-weight:700;font-size:.95rem;margin-bottom:16px;padding-bottom:11px;border-bottom:1px solid var(--border);}
.upload-z{border:2.5px dashed var(--border);border-radius:var(--radius-sm);padding:36px 20px;text-align:center;cursor:pointer;transition:all .2s;background:var(--sand);position:relative;}
.upload-z:hover,.upload-z.drag{border-color:var(--terra);background:var(--terra-light);}
.upload-z input{display:none;}
.upl-icon{font-size:2.5rem;margin-bottom:8px;}
.upl-title{font-weight:700;font-size:1rem;margin-bottom:3px;}
.upl-sub{font-size:.82rem;color:var(--muted);}
.photos-prev{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;}
.ph-thumb{position:relative;width:90px;height:72px;border-radius:8px;overflow:hidden;}
.ph-thumb img{width:100%;height:100%;object-fit:cover;}
.ph-rm{position:absolute;top:3px;right:3px;width:20px;height:20px;background:rgba(0,0,0,.65);color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:.65rem;display:flex;align-items:center;justify-content:center;}
.cats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;}
.cato{padding:11px 6px;border:2px solid var(--border);border-radius:var(--radius-sm);text-align:center;cursor:pointer;transition:all .2s;}
.cato:hover{border-color:var(--terra);}
.cato.sel{border-color:var(--terra);background:var(--terra-light);}
.cato-icon{font-size:1.5rem;margin-bottom:3px;}
.cato-name{font-size:.72rem;font-weight:600;color:var(--muted);}
.cato.sel .cato-name{color:var(--terra);}
.price-row{display:grid;grid-template-columns:1fr 120px;gap:10px;}
.btn-submit{width:100%;padding:16px;background:var(--terra);color:#fff;border:none;border-radius:var(--radius-sm);font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-submit:hover{background:var(--terra-dark);}
.btn-submit:active{transform:scale(.98);}

/* ===== DASHBOARD ===== */
.dash-wrap{max-width:1060px;margin:0 auto;padding:24px 16px;padding-bottom:calc(var(--bottom-nav-h) + 20px);}
.dash-hd{background:#fff;border-radius:var(--radius);padding:20px;border:1px solid var(--border);margin-bottom:22px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.dash-av{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--terra),var(--gold));display:flex;align-items:center;justify-content:center;color:var(--deep);font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;flex-shrink:0;}
.dash-nm{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:700;}
.dash-em{color:var(--muted);font-size:.85rem;margin-top:2px;}
.dash-ph{color:var(--muted2);font-size:.78rem;margin-top:2px;}
.dash-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:22px;}
.stat-c{background:#fff;border-radius:var(--radius-sm);padding:16px;border:1px solid var(--border);}
.stat-num{font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;color:var(--terra);}
.stat-lbl{font-size:.75rem;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.4px;}
.profile-sec{background:#fff;border-radius:var(--radius);border:1px solid var(--border);padding:20px;margin-bottom:20px;}
.profile-sec h3{font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;padding-bottom:11px;border-bottom:1px solid var(--border);}
.dash-list-title{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:14px;}
.listing-row{background:#fff;border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border);display:flex;align-items:center;gap:14px;margin-bottom:10px;transition:all .2s;cursor:pointer;}
.listing-row:hover{border-color:var(--terra);}
.lr-img{width:64px;height:52px;border-radius:8px;overflow:hidden;background:var(--sand);flex-shrink:0;}
.lr-img img{width:100%;height:100%;object-fit:cover;}
.lr-title{font-weight:600;font-size:.88rem;margin-bottom:2px;}
.lr-price{font-family:'Syne',sans-serif;font-weight:700;color:var(--terra);font-size:.9rem;}
.lr-acts{display:flex;gap:7px;margin-left:auto;flex-shrink:0;}
.icon-btn{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.82rem;transition:all .15s;}
.icon-btn:hover{border-color:var(--terra);color:var(--terra);}
.icon-btn.del:hover{border-color:#DC2626;color:#DC2626;}
.dash-empty{text-align:center;padding:50px 20px;}
.dash-empty .de-icon{font-size:3rem;margin-bottom:10px;opacity:.5;}

/* ===== CHAT PAGE ===== */
#chat-page{display:none;min-height:calc(100vh - var(--nav-h));}
#chat-page.active{display:flex;}
.chat-layout{display:flex;width:100%;height:calc(100vh - var(--nav-h));overflow:hidden;}
/* Conversations sidebar */
.conv-sidebar{width:340px;flex-shrink:0;background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.conv-hd{padding:20px 16px 14px;border-bottom:1px solid var(--border);}
.conv-hd-title{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;}
.conv-search{position:relative;margin-top:10px;}
.conv-search input{width:100%;padding:9px 12px 9px 36px;border:1.5px solid var(--border);border-radius:10px;font-size:.85rem;outline:none;background:var(--sand);}
.conv-search input:focus{border-color:var(--terra);}
.conv-search-ic{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.9rem;pointer-events:none;}
.conv-list{flex:1;overflow-y:auto;}
.conv-item{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border2);position:relative;}
.conv-item:hover,.conv-item.active{background:var(--sand);}
.conv-av{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--terra),var(--gold));display:flex;align-items:center;justify-content:center;color:var(--deep);font-weight:700;font-size:1.1rem;flex-shrink:0;}
.conv-info{flex:1;min-width:0;}
.conv-name{font-weight:600;font-size:.9rem;margin-bottom:2px;}
.conv-preview{font-size:.78rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.conv-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;}
.conv-time{font-size:.7rem;color:var(--muted2);}
.conv-unread{width:18px;height:18px;background:var(--terra);border-radius:50%;font-size:.65rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;}
.conv-prod-thumb{width:38px;height:30px;border-radius:6px;overflow:hidden;background:var(--sand);flex-shrink:0;}
.conv-prod-thumb img{width:100%;height:100%;object-fit:cover;}
.conv-empty{padding:40px 20px;text-align:center;color:var(--muted);font-size:.9rem;}
/* Chat window */
.chat-window{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--cream);}
.chat-hd{padding:14px 20px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;}
.chat-back{display:none;width:36px;height:36px;border:none;background:transparent;cursor:pointer;font-size:1.2rem;color:var(--muted);flex-shrink:0;}
.chat-hd-av{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--terra),var(--gold));display:flex;align-items:center;justify-content:center;color:var(--deep);font-weight:700;font-size:.95rem;flex-shrink:0;}
.chat-hd-info{flex:1;min-width:0;}
.chat-hd-name{font-weight:700;font-size:.95rem;}
.chat-hd-status{font-size:.72rem;color:var(--forest);}
.chat-prod-card{display:flex;align-items:center;gap:10px;padding:10px 16px;background:var(--sand);border-bottom:1px solid var(--border);cursor:pointer;}
.chat-prod-card:hover{background:var(--border2);}
.chat-prod-img{width:40px;height:32px;border-radius:6px;overflow:hidden;background:#fff;flex-shrink:0;}
.chat-prod-img img{width:100%;height:100%;object-fit:cover;}
.chat-prod-name{font-size:.82rem;font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.chat-prod-price{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:700;color:var(--terra);flex-shrink:0;}
/* Messages area */
.msgs-area{flex:1;overflow-y:auto;padding:20px 16px;display:flex;flex-direction:column;gap:10px;}
.msg-day{text-align:center;font-size:.72rem;color:var(--muted);margin:8px 0;font-weight:600;}
.msg-row{display:flex;gap:8px;max-width:75%;}
.msg-row.mine{align-self:flex-end;flex-direction:row-reverse;}
.msg-row.theirs{align-self:flex-start;}
.msg-av{width:30px;height:30px;border-radius:50%;background:var(--sand);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0;align-self:flex-end;}
.msg-row.mine .msg-av{background:var(--terra);color:#fff;}
.msg-row.theirs .msg-av{background:var(--forest);color:#fff;}
.msg-bub{padding:10px 14px;border-radius:14px;font-size:.88rem;line-height:1.5;max-width:100%;}
.msg-row.mine .msg-bub{background:var(--terra);color:#fff;border-radius:14px 14px 4px 14px;}
.msg-row.theirs .msg-bub{background:#fff;color:var(--deep);border:1px solid var(--border);border-radius:14px 14px 14px 4px;}
.msg-time{font-size:.65rem;color:rgba(255,255,255,.6);margin-top:4px;text-align:right;}
.msg-row.theirs .msg-time{color:var(--muted2);text-align:left;}
/* Input area */
.chat-input-area{padding:12px 16px;background:#fff;border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:10px;}
.chat-input-wrap{flex:1;position:relative;}
.chat-input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:24px;font-size:.9rem;outline:none;resize:none;max-height:100px;overflow-y:auto;transition:border-color .2s;background:var(--sand);}
.chat-input:focus{border-color:var(--terra);background:#fff;}
.chat-send{width:42px;height:42px;border-radius:50%;background:var(--terra);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:#fff;flex-shrink:0;transition:all .2s;}
.chat-send:hover{background:var(--terra-dark);}
.chat-send:active{transform:scale(.95);}
.chat-emoji-btn{width:36px;height:36px;border:none;background:transparent;cursor:pointer;font-size:1.1rem;color:var(--muted);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:color .2s;}
.chat-emoji-btn:hover{color:var(--terra);}
/* No chat selected */
.chat-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--muted);}
.chat-empty .ce-icon{font-size:4rem;opacity:.4;}
.chat-empty p{font-size:.9rem;}
/* Mobile chat */
.conv-sidebar.hidden-mobile{display:flex;}
.chat-window.hidden-mobile{display:flex;}

/* ===== MODAL ===== */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:flex-end;justify-content:center;padding:0;}
.modal-ov.open{display:flex;animation:fadeIn .15s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:#fff;border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:24px;width:100%;max-width:520px;animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.modal-title{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;}
.modal-close{width:30px;height:30px;border:none;background:var(--sand);border-radius:8px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;}

/* ===== RESPONSIVE ===== */
@media(max-width:900px){
  .auth-left{display:none;}
  .auth-right{width:100%;}
  .auth-mobile-header{display:flex;}
  .auth-right{padding:24px 20px 40px;}
  .detail-grid{grid-template-columns:1fr;}
  .dash-stats{grid-template-columns:repeat(2,1fr);}
  .chat-layout{height:calc(100vh - var(--nav-h) - var(--bottom-nav-h));}
  /* chat sidebar/window mobile toggle */
  .conv-sidebar{width:100%;border-right:none;}
  .conv-sidebar.show-chat{display:none;}
  .chat-window{display:none;}
  .chat-window.show-chat{display:flex;}
  .chat-back{display:flex;}
  .navbar .nav-btn-sell{display:none;}
  .bottom-nav{display:flex;}
  body{padding-bottom:0;}
  .page,.chat-layout{padding-bottom:0;}
  #toast{bottom:calc(var(--bottom-nav-h)+12px);}
}
@media(max-width:600px){
  .hero-title{font-size:1.8rem;}
  .hero-stats{gap:18px;}
  .hero{padding:28px 16px;}
  .grid{grid-template-columns:repeat(2,1fr);gap:10px;}
  .pcard-body{padding:10px 12px;}
  .pcard-title{font-size:.82rem;}
  .pcard-price{font-size:.95rem;}
  .navbar{padding:0 14px;}
  .nav-search{display:none;}
  .dash-stats{grid-template-columns:repeat(2,1fr);}
  .det-title{font-size:1.3rem;}
  .det-price{font-size:1.6rem;}
  .frow{grid-template-columns:1fr;}
  .price-row{grid-template-columns:1fr 100px;}
  .cats-grid{grid-template-columns:repeat(auto-fill,minmax(85px,1fr));}
  .dash-hd{gap:12px;}
  .dash-nm{font-size:1.2rem;}
}
@media(max-width:360px){
  .grid{grid-template-columns:1fr 1fr;}
  .pcard-body{padding:8px 10px;}
}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="loader-logo">Luvano</div>
  <div class="loader-tag">üá≤üáø Marketplace de Mo√ßambique</div>
  <div class="loader-track"><div class="loader-bar"></div></div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- ====== AUTH ====== -->
<div id="auth-page">
  <!-- Animated background layers -->
  <div class="auth-bg">
    <div class="auth-bg-grad"></div>
    <div class="auth-bg-circle1"></div>
    <div class="auth-bg-circle2"></div>
    <div class="auth-bg-dots"></div>
  </div>

  <div class="auth-wrap">

    <!-- ‚îÄ‚îÄ DESKTOP LEFT PANEL (hidden on mobile via CSS) ‚îÄ‚îÄ -->
    <div class="auth-left-desk" style="display:none">
      <div style="text-align:center">
        <div class="auth-desk-logo">Luvano</div>
        <div class="auth-desk-tag">üá≤üáø O Mercado Digital de Mo√ßambique</div>
      </div>
      <div class="auth-feats-desk" style="display:none">
        <div class="auth-feat-desk"><div class="auth-feat-icon">üõí</div><div class="auth-feat-txt"><strong>Compre e venda</strong> em todo Mo√ßambique com facilidade</div></div>
        <div class="auth-feat-desk"><div class="auth-feat-icon">üí∞</div><div class="auth-feat-txt">Suporte a <strong>Metical, D√≥lar, Euro, Rand</strong> e mais moedas</div></div>
        <div class="auth-feat-desk"><div class="auth-feat-icon">üí¨</div><div class="auth-feat-txt">Chat integrado + contacto direto pelo <strong>WhatsApp</strong></div></div>
        <div class="auth-feat-desk"><div class="auth-feat-icon">‚≠ê</div><div class="auth-feat-txt">Sistema de <strong>avalia√ß√µes</strong> para compras confi√°veis</div></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ MOBILE HERO (shown on mobile, hidden on desktop) ‚îÄ‚îÄ -->
    <div class="auth-hero">
      <div class="auth-logo-flag">üá≤üáø</div>
      <div class="auth-logo">Luvano</div>
      <div class="auth-tagline">O Mercado Digital de Mo√ßambique</div>
      <div class="auth-pills">
        <div class="auth-pill">üõí Compra & Venda</div>
        <div class="auth-pill">üí¨ Chat Direto</div>
        <div class="auth-pill">üí∞ Multi-Moeda</div>
        <div class="auth-pill">‚≠ê Avalia√ß√µes</div>
        <div class="auth-pill">üì± WhatsApp</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ FORM CARD (bottom sheet on mobile, right panel on desktop) ‚îÄ‚îÄ -->
    <div class="auth-card-wrap">
      <div class="auth-card">

        <!-- Tabs -->
        <div class="auth-tabs">
          <div class="auth-tab active" onclick="authTab('login')" id="tab-login">üîë Entrar</div>
          <div class="auth-tab" onclick="authTab('register')" id="tab-reg">‚ú® Cadastrar</div>
        </div>

        <!-- ‚îÄ‚îÄ LOGIN FORM ‚îÄ‚îÄ -->
        <div id="login-form">
          <h2 class="form-h">Bem-vindo de volta!</h2>
          <p class="form-sub">Entre na sua conta Luvano</p>

          <div class="auth-err" id="login-err"></div>

          <div class="fgroup">
            <label class="flabel">üìß Email</label>
            <input type="email" class="finput" id="l-email" placeholder="seu@email.com"
              autocomplete="email" inputmode="email" enterkeyhint="next">
          </div>

          <div class="fgroup">
            <label class="flabel">üîí Senha</label>
            <div class="pass-wrap">
              <input type="password" class="finput" id="l-pass" placeholder="M√≠nimo 6 caracteres"
                autocomplete="current-password" enterkeyhint="done" onkeydown="if(event.key==='Enter')doLogin()">
              <button class="pass-eye" type="button" onclick="togglePass('l-pass',this)" tabindex="-1">üëÅÔ∏è</button>
            </div>
          </div>

          <button class="btn-main" onclick="doLogin()" id="btn-login">Entrar na minha conta ‚Üí</button>

          <div class="auth-divider">ou</div>

          <button style="width:100%;padding:13px;background:transparent;border:2px solid var(--border);border-radius:12px;font-size:.9rem;font-weight:600;cursor:pointer;color:var(--deep);display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s" onclick="authTab('register')">
            N√£o tem conta? <strong style="color:var(--terra)">Criar agora</strong>
          </button>

          <p class="auth-note">Ao entrar aceita os <a href="#">Termos de Uso</a> e <a href="#">Privacidade</a></p>
        </div>

        <!-- ‚îÄ‚îÄ REGISTER FORM ‚îÄ‚îÄ -->
        <div id="reg-form" style="display:none">
          <h2 class="form-h">Criar conta gr√°tis</h2>
          <p class="form-sub">Junte-se ao maior mercado de Mo√ßambique</p>

          <!-- Progress steps -->
          <div class="reg-steps">
            <div class="reg-step active" id="rs1"></div>
            <div class="reg-step" id="rs2"></div>
            <div class="reg-step" id="rs3"></div>
          </div>

          <div class="auth-err" id="reg-err"></div>

          <div class="frow">
            <div class="fgroup">
              <label class="flabel">üë§ Nome</label>
              <input type="text" class="finput" id="r-name" placeholder="Primeiro nome"
                autocomplete="given-name" oninput="updateRegProgress()">
            </div>
            <div class="fgroup">
              <label class="flabel">üë§ Apelido</label>
              <input type="text" class="finput" id="r-sname" placeholder="Apelido"
                autocomplete="family-name">
            </div>
          </div>

          <div class="fgroup">
            <label class="flabel">üìß Email</label>
            <input type="email" class="finput" id="r-email" placeholder="seu@email.com"
              autocomplete="email" inputmode="email" oninput="updateRegProgress()">
          </div>

          <div class="fgroup">
            <label class="flabel">üì± WhatsApp / Telefone</label>
            <input type="tel" class="finput" id="r-phone" placeholder="+258 84 000 0000"
              autocomplete="tel" inputmode="tel">
          </div>

          <div class="fgroup">
            <label class="flabel">üìç Cidade</label>
            <select class="finput" id="r-city">
              <option value="">Selecione a sua cidade...</option>
              <option>Maputo</option><option>Matola</option><option>Beira</option>
              <option>Nampula</option><option>Quelimane</option><option>Tete</option>
              <option>Chimoio</option><option>Nacala</option><option>Lichinga</option>
              <option>Pemba</option><option>Inhambane</option><option>Xai-Xai</option>
              <option>Maxixe</option><option>Mocuba</option><option>Cuamba</option>
              <option>Outra</option>
            </select>
          </div>

          <div class="fgroup">
            <label class="flabel">üîí Senha</label>
            <div class="pass-wrap">
              <input type="password" class="finput" id="r-pass" placeholder="M√≠nimo 6 caracteres"
                autocomplete="new-password" oninput="updateRegProgress();checkPassStrength(this.value)">
              <button class="pass-eye" type="button" onclick="togglePass('r-pass',this)" tabindex="-1">üëÅÔ∏è</button>
            </div>
            <!-- Password strength bar -->
            <div id="pass-strength" style="margin-top:6px;display:none">
              <div style="display:flex;gap:4px;margin-bottom:4px">
                <div class="str-bar" id="sb1" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .3s"></div>
                <div class="str-bar" id="sb2" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .3s"></div>
                <div class="str-bar" id="sb3" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .3s"></div>
                <div class="str-bar" id="sb4" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .3s"></div>
              </div>
              <div id="str-label" style="font-size:.72rem;color:var(--muted)"></div>
            </div>
          </div>

          <button class="btn-main" onclick="doRegister()" id="btn-reg">Criar minha conta gr√°tis ‚Üí</button>

          <div class="auth-divider">j√° tem conta?</div>

          <button style="width:100%;padding:13px;background:transparent;border:2px solid var(--border);border-radius:12px;font-size:.9rem;font-weight:600;cursor:pointer;color:var(--deep);transition:all .2s" onclick="authTab('login')">
            <strong style="color:var(--terra)">Entrar</strong> na minha conta
          </button>

          <p class="auth-note">Ao cadastrar aceita os <a href="#">Termos de Uso</a> e <a href="#">Pol√≠tica de Privacidade</a></p>
        </div>

        <!-- ‚îÄ‚îÄ OTP VERIFICATION ‚îÄ‚îÄ -->
        <div id="otp-form" class="otp-wrap">
          <div class="otp-icon">üìß</div>
          <h2 class="otp-title">Confirme o seu email</h2>
          <p class="otp-sub">Envi√°mos um c√≥digo de 6 d√≠gitos para<br><span class="otp-email" id="otp-email-display">seu@email.com</span></p>
          
          <div class="otp-inputs" id="otp-inputs">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
            <input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
          </div>

          <div class="auth-err" id="otp-err"></div>

          <div class="otp-timer" id="otp-timer">C√≥digo v√°lido por <span id="otp-countdown">60</span>s</div>

          <button class="otp-resend" id="otp-resend-btn" onclick="resendOTP()" disabled>
            ‚Üª Reenviar c√≥digo
          </button>

          <button class="btn-main" style="margin-top:24px;max-width:260px" onclick="verifyOTP()" id="btn-verify">
            Verificar c√≥digo ‚Üí
          </button>

          <div class="otp-back" onclick="cancelOTP()">
            ‚Üê Voltar ao cadastro
          </div>
        </div>

      </div><!-- /auth-card -->
    </div><!-- /auth-card-wrap -->

  </div><!-- /auth-wrap -->
</div>

<!-- ====== MAIN APP ====== -->
<div id="main-app" style="display:none">
  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="nav-logo" onclick="goTo('home')">Luvano</div>
    <div class="nav-search">
      <span class="nav-search-ic">üîç</span>
      <input type="text" id="search-inp" placeholder="Buscar produtos..." oninput="doSearch(this.value)">
    </div>
    <div class="nav-actions">
      <button class="nav-chat-btn" onclick="goTo('chat')" title="Mensagens">
        üí¨<span class="nav-badge" id="nav-badge"></span>
      </button>
      <button class="nav-btn-sell" onclick="goTo('create')">+ Vender</button>
      <div class="nav-av-wrap">
        <div class="nav-av" id="nav-av" onclick="toggleDD()">?</div>
        <div class="dropdown" id="nav-dd">
          <div class="dd-item" onclick="goTo('dashboard');closeDD()">üë§ Meu Perfil</div>
          <div class="dd-item" onclick="goTo('chat');closeDD()">üí¨ Mensagens</div>
          <div class="dd-item" onclick="goTo('create');closeDD()">‚ûï Novo An√∫ncio</div>
          <div class="dd-sep"></div>
          <div class="dd-item red" onclick="doLogout()">üö™ Sair</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- CATEGORIES BAR -->
  <div class="cats-bar">
    <div class="cat-chip active" onclick="filterCat('all',this)">üè† Tudo</div>
    <div class="cat-chip" onclick="filterCat('eletronicos',this)">üì± Eletr√≥nicos</div>
    <div class="cat-chip" onclick="filterCat('veiculos',this)">üöó Ve√≠culos</div>
    <div class="cat-chip" onclick="filterCat('imoveis',this)">üè† Im√≥veis</div>
    <div class="cat-chip" onclick="filterCat('roupas',this)">üëó Roupas</div>
    <div class="cat-chip" onclick="filterCat('calcados',this)">üëü Cal√ßados</div>
    <div class="cat-chip" onclick="filterCat('moveis',this)">üõãÔ∏è M√≥veis</div>
    <div class="cat-chip" onclick="filterCat('eletrodomesticos',this)">üç≥ Eletrodom√©sticos</div>
    <div class="cat-chip" onclick="filterCat('servicos',this)">üîß Servi√ßos</div>
    <div class="cat-chip" onclick="filterCat('animais',this)">üêæ Animais</div>
    <div class="cat-chip" onclick="filterCat('agricultura',this)">üåæ Agricultura</div>
    <div class="cat-chip" onclick="filterCat('beleza',this)">üíÖ Beleza</div>
    <div class="cat-chip" onclick="filterCat('criancas',this)">üß∏ Crian√ßas</div>
    <div class="cat-chip" onclick="filterCat('desporto',this)">‚öΩ Desporto</div>
    <div class="cat-chip" onclick="filterCat('musica',this)">üéµ M√∫sica</div>
    <div class="cat-chip" onclick="filterCat('outros',this)">üì¶ Outros</div>
  </div>

  <!-- ====== HOME ====== -->
  <div id="home-page" class="page active">
    <div class="hero">
      <div class="hero-in">
        <div class="hero-badge">üá≤üáø Feito em Mo√ßambique</div>
        <h1 class="hero-title">O maior mercado<br><span>digital de Mo√ßambique</span></h1>
        <p class="hero-desc">Compre, venda e negocie produtos de forma simples. Conectamos compradores e vendedores em todo o pa√≠s.</p>
        <div class="hero-stats">
          <div class="h-stat"><div class="num" id="st-listings">0</div><div class="lbl">An√∫ncios</div></div>
          <div class="h-stat"><div class="num" id="st-users">1.2k</div><div class="lbl">Usu√°rios</div></div>
          <div class="h-stat"><div class="num">11</div><div class="lbl">Prov√≠ncias</div></div>
        </div>
      </div>
    </div>
    <!-- Mobile search bar -->
    <div style="padding:12px 16px;background:#fff;border-bottom:1px solid var(--border);display:none" id="mobile-search-bar">
      <div style="position:relative">
        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)">üîç</span>
        <input type="text" placeholder="Buscar produtos..." oninput="doSearch(this.value)" style="width:100%;padding:10px 14px 10px 38px;border:1.5px solid var(--border);border-radius:24px;font-size:.9rem;outline:none;background:var(--sand);">
      </div>
    </div>
    <div class="content">
      <div class="sec-hd">
        <h2 class="sec-title" id="sec-label">‚ú® An√∫ncios Recentes</h2>
        <span class="sec-link" onclick="goTo('create')">+ Publicar</span>
      </div>
      <div class="grid" id="products-grid">
        <div class="no-items" style="grid-column:1/-1"><div class="ni-icon">‚è≥</div><h3>Carregando...</h3></div>
      </div>
    </div>
  </div>

  <!-- ====== DETAIL ====== -->
  <div id="detail-page" class="page">
    <div class="detail-wrap">
      <div class="back-btn" onclick="goTo('home')">‚Üê Voltar</div>
      <div class="detail-grid">
        <!-- Images -->
        <div class="det-imgs">
          <div class="det-main" id="det-main-img"></div>
          <div class="thumbs" id="det-thumbs"></div>
        </div>
        <!-- Info -->
        <div class="det-info">
          <div class="det-cat" id="d-cat"></div>
          <h1 class="det-title" id="d-title"></h1>
          <div class="det-price-row">
            <div class="det-price" id="d-price"></div>
            <select class="curr-sel" id="curr-sel" onchange="convertCurr()">
              <option value="MZN">üá≤üáø MZN</option>
              <option value="USD">üá∫üá∏ USD</option>
              <option value="EUR">üá™üá∫ EUR</option>
              <option value="ZAR">üáøüá¶ ZAR</option>
              <option value="GBP">üá¨üáß GBP</option>
              <option value="BRL">üáßüá∑ BRL</option>
              <option value="KES">üá∞üá™ KES</option>
            </select>
          </div>
          <div class="det-rating">
            <div class="stars-lg" id="d-stars"></div>
            <span id="d-rate-txt" style="font-size:.82rem;color:var(--muted)"></span>
          </div>
          <div class="det-loc" id="d-loc"></div>
          <p class="det-desc" id="d-desc"></p>
          <div class="seller-box" id="seller-box" onclick="openSellerChat()">
            <div class="seller-av" id="d-sav"></div>
            <div>
              <div class="seller-nm" id="d-snm"></div>
              <div class="seller-info" id="d-sinfo"></div>
            </div>
            <span style="margin-left:auto;color:var(--terra);font-size:.8rem;font-weight:600">üí¨ Chat</span>
          </div>
          <div class="det-actions">
            <button class="btn-wa" onclick="contactWA()">üì± Contactar pelo WhatsApp</button>
            <button class="btn-chat" onclick="openSellerChat()">üí¨ Enviar Mensagem</button>
            <button class="btn-share" onclick="shareProduct()">üîó Partilhar An√∫ncio</button>
          </div>
        </div>
      </div>
      <!-- Reviews -->
      <div class="reviews-sec">
        <h3 class="rev-title">‚≠ê Avalia√ß√µes</h3>
        <div class="rate-box">
          <div class="rate-lbl">Avaliar este produto</div>
          <div class="star-btns" id="star-btns">
            <span class="sbtn" onclick="setRat(1)">‚òÖ</span><span class="sbtn" onclick="setRat(2)">‚òÖ</span>
            <span class="sbtn" onclick="setRat(3)">‚òÖ</span><span class="sbtn" onclick="setRat(4)">‚òÖ</span>
            <span class="sbtn" onclick="setRat(5)">‚òÖ</span>
          </div>
          <textarea class="finput" id="rev-txt" placeholder="Escreva o seu coment√°rio..." style="min-height:75px;resize:vertical;margin-bottom:10px;display:block;width:100%"></textarea>
          <button class="btn-main" style="width:auto;padding:10px 22px;font-size:.9rem" onclick="submitRev()">Enviar</button>
        </div>
        <div class="rev-list" id="rev-list"></div>
      </div>
    </div>
  </div>

  <!-- ====== CREATE ====== -->
  <div id="create-page" class="page">
    <div class="create-wrap">
      <div class="back-btn" onclick="goTo('home')">‚Üê Voltar</div>
      <h1 class="pg-title">Publicar An√∫ncio</h1>
      <p class="pg-sub">Venda os seus produtos a milhares de compradores em Mo√ßambique</p>

      <div class="fsec">
        <div class="fsec-title">üì∏ Fotos do Produto</div>
        <div class="upload-z" id="upload-z" onclick="document.getElementById('ph-input').click()"
             ondrop="onDrop(event)" ondragover="onDragOver(event)" ondragleave="this.classList.remove('drag')">
          <input type="file" id="ph-input" accept="image/*" multiple onchange="onPhotos(this.files)">
          <div class="upl-icon">üì∑</div>
          <div class="upl-title">Clique ou arraste fotos aqui</div>
          <div class="upl-sub">At√© 8 fotos ‚Ä¢ PNG, JPG, WEBP ‚Ä¢ M√°x. 5MB cada</div>
        </div>
        <div class="photos-prev" id="photos-prev"></div>
      </div>

      <div class="fsec">
        <div class="fsec-title">üè∑Ô∏è Categoria</div>
        <div class="cats-grid">
          <div class="cato" onclick="selCat('eletronicos',this)"><div class="cato-icon">üì±</div><div class="cato-name">Eletr√≥nicos</div></div>
          <div class="cato" onclick="selCat('veiculos',this)"><div class="cato-icon">üöó</div><div class="cato-name">Ve√≠culos</div></div>
          <div class="cato" onclick="selCat('imoveis',this)"><div class="cato-icon">üè†</div><div class="cato-name">Im√≥veis</div></div>
          <div class="cato" onclick="selCat('roupas',this)"><div class="cato-icon">üëó</div><div class="cato-name">Roupas</div></div>
          <div class="cato" onclick="selCat('calcados',this)"><div class="cato-icon">üëü</div><div class="cato-name">Cal√ßados</div></div>
          <div class="cato" onclick="selCat('moveis',this)"><div class="cato-icon">üõãÔ∏è</div><div class="cato-name">M√≥veis</div></div>
          <div class="cato" onclick="selCat('eletrodomesticos',this)"><div class="cato-icon">üç≥</div><div class="cato-name">Eletrodom√©sticos</div></div>
          <div class="cato" onclick="selCat('servicos',this)"><div class="cato-icon">üîß</div><div class="cato-name">Servi√ßos</div></div>
          <div class="cato" onclick="selCat('animais',this)"><div class="cato-icon">üêæ</div><div class="cato-name">Animais</div></div>
          <div class="cato" onclick="selCat('agricultura',this)"><div class="cato-icon">üåæ</div><div class="cato-name">Agricultura</div></div>
          <div class="cato" onclick="selCat('beleza',this)"><div class="cato-icon">üíÖ</div><div class="cato-name">Beleza</div></div>
          <div class="cato" onclick="selCat('criancas',this)"><div class="cato-icon">üß∏</div><div class="cato-name">Crian√ßas</div></div>
          <div class="cato" onclick="selCat('desporto',this)"><div class="cato-icon">‚öΩ</div><div class="cato-name">Desporto</div></div>
          <div class="cato" onclick="selCat('musica',this)"><div class="cato-icon">üéµ</div><div class="cato-name">M√∫sica</div></div>
          <div class="cato" onclick="selCat('outros',this)"><div class="cato-icon">üì¶</div><div class="cato-name">Outros</div></div>
        </div>
      </div>

      <div class="fsec">
        <div class="fsec-title">üìù Detalhes</div>
        <div class="fgroup"><label class="flabel">T√≠tulo do An√∫ncio</label><input type="text" class="finput" id="c-title" placeholder="Ex: iPhone 14 Pro 256GB - Como novo"></div>
        <div class="fgroup"><label class="flabel">Descri√ß√£o</label><textarea class="finput" id="c-desc" placeholder="Descreva o produto: estado, caracter√≠sticas, motivo de venda..." style="min-height:110px;resize:vertical"></textarea></div>
        <div class="price-row">
          <div class="fgroup" style="margin-bottom:0"><label class="flabel">Pre√ßo</label><input type="number" class="finput" id="c-price" placeholder="0.00"></div>
          <div class="fgroup" style="margin-bottom:0"><label class="flabel">Moeda</label>
            <select class="finput" id="c-curr">
              <option value="MZN">üá≤üáø MZN</option><option value="USD">üá∫üá∏ USD</option>
              <option value="EUR">üá™üá∫ EUR</option><option value="ZAR">üáøüá¶ ZAR</option>
              <option value="GBP">üá¨üáß GBP</option><option value="BRL">üáßüá∑ BRL</option>
              <option value="KES">üá∞üá™ KES</option>
            </select>
          </div>
        </div>
      </div>

      <div class="fsec">
        <div class="fsec-title">üìç Localiza√ß√£o & Contacto</div>
        <div class="frow">
          <div class="fgroup"><label class="flabel">Cidade</label>
            <select class="finput" id="c-city">
              <option value="">Selecione...</option>
              <option>Maputo</option><option>Matola</option><option>Beira</option>
              <option>Nampula</option><option>Quelimane</option><option>Tete</option>
              <option>Chimoio</option><option>Nacala</option><option>Lichinga</option>
              <option>Pemba</option><option>Inhambane</option><option>Xai-Xai</option>
              <option>Maxixe</option><option>Mocuba</option><option>Cuamba</option>
            </select>
          </div>
          <div class="fgroup"><label class="flabel">Bairro / Zona</label><input type="text" class="finput" id="c-zone" placeholder="Polana, Sommerschield..."></div>
        </div>
        <div class="fgroup"><label class="flabel">WhatsApp</label><input type="tel" class="finput" id="c-wa" placeholder="+258 84 000 0000"></div>
        <div class="fgroup"><label class="flabel">Condi√ß√£o</label>
          <select class="finput" id="c-cond">
            <option value="novo">‚ú® Novo</option><option value="semi-novo">üëç Semi-novo</option>
            <option value="usado">üîÑ Usado - Bom estado</option><option value="para-pecas">üîß Para pe√ßas</option>
          </select>
        </div>
      </div>
      <button class="btn-submit" onclick="submitListing()">üöÄ Publicar An√∫ncio</button>
    </div>
  </div>

  <!-- ====== CHAT ====== -->
  <div id="chat-page" class="page">
    <div class="chat-layout">
      <!-- Sidebar -->
      <div class="conv-sidebar" id="conv-sidebar">
        <div class="conv-hd">
          <div class="conv-hd-title">üí¨ Mensagens</div>
          <div class="conv-search">
            <span class="conv-search-ic">üîç</span>
            <input type="text" placeholder="Buscar conversa..." oninput="filterConvs(this.value)">
          </div>
        </div>
        <div class="conv-list" id="conv-list">
          <div class="conv-empty">Nenhuma conversa ainda.<br>Entre num an√∫ncio e envie uma mensagem!</div>
        </div>
      </div>
      <!-- Chat window -->
      <div class="chat-window" id="chat-window">
        <div class="chat-empty" id="chat-empty">
          <div class="ce-icon">üí¨</div>
          <p>Selecione uma conversa para come√ßar</p>
        </div>
        <div id="chat-active" style="display:none;flex-direction:column;flex:1;overflow:hidden">
          <div class="chat-hd">
            <button class="chat-back" onclick="closeChat()">‚Üê</button>
            <div class="chat-hd-av" id="ch-av">?</div>
            <div class="chat-hd-info">
              <div class="chat-hd-name" id="ch-name">...</div>
              <div class="chat-hd-status">‚óè Online</div>
            </div>
            <button class="btn-wa" style="padding:8px 14px;width:auto;font-size:.8rem;border-radius:8px" onclick="chatWA()">üì± WhatsApp</button>
          </div>
          <div class="chat-prod-card" id="chat-prod-card" onclick="viewChatProduct()">
            <div class="chat-prod-img" id="chat-prod-img"></div>
            <div class="chat-prod-name" id="chat-prod-name"></div>
            <div class="chat-prod-price" id="chat-prod-price"></div>
          </div>
          <div class="msgs-area" id="msgs-area"></div>
          <div class="chat-input-area">
            <button class="chat-emoji-btn" onclick="insertEmoji()">üòä</button>
            <div class="chat-input-wrap">
              <textarea class="chat-input" id="chat-inp" placeholder="Escreva uma mensagem..." rows="1"
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"
                oninput="autoResize(this)"></textarea>
            </div>
            <button class="chat-send" onclick="sendMsg()">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== DASHBOARD ====== -->
  <div id="dashboard-page" class="page">
    <div class="dash-wrap">
      <h1 style="font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;margin-bottom:16px">Meu Painel</h1>
      <div class="dash-hd">
        <div class="dash-av" id="dash-av">?</div>
        <div>
          <div class="dash-nm" id="dash-nm">...</div>
          <div class="dash-em" id="dash-em">...</div>
          <div class="dash-ph" id="dash-ph"></div>
        </div>
        <button class="btn-main" style="margin-left:auto;width:auto;padding:10px 20px;font-size:.85rem" onclick="goTo('create')">+ An√∫ncio</button>
      </div>
      <div class="dash-stats">
        <div class="stat-c"><div class="stat-num" id="ds-l">0</div><div class="stat-lbl">An√∫ncios</div></div>
        <div class="stat-c"><div class="stat-num" id="ds-v">0</div><div class="stat-lbl">Visualiza√ß√µes</div></div>
        <div class="stat-c"><div class="stat-num" id="ds-r">0</div><div class="stat-lbl">Avalia√ß√µes</div></div>
        <div class="stat-c"><div class="stat-num" id="ds-rt">-</div><div class="stat-lbl">Rating</div></div>
      </div>
      <div class="profile-sec">
        <h3>‚úèÔ∏è Editar Perfil</h3>
        <div class="frow">
          <div class="fgroup"><label class="flabel">Nome completo</label><input type="text" class="finput" id="pf-name"></div>
          <div class="fgroup"><label class="flabel">Cidade</label><input type="text" class="finput" id="pf-city"></div>
        </div>
        <div class="fgroup"><label class="flabel">WhatsApp</label><input type="tel" class="finput" id="pf-phone" placeholder="+258..."></div>
        <button class="btn-main" style="width:auto;padding:10px 24px;font-size:.9rem" onclick="saveProfile()">Guardar</button>
      </div>
      <div class="dash-list-title">üì¶ Meus An√∫ncios</div>
      <div id="my-listings"></div>
    </div>
  </div>

  <!-- BOTTOM NAV (mobile) -->
  <nav class="bottom-nav">
    <div class="bn-list">
      <div class="bn-item active" id="bn-home" onclick="goTo('home');setBN('home')">
        <div class="bn-icon">üè†</div><div class="bn-label">In√≠cio</div>
      </div>
      <div class="bn-item" id="bn-search" onclick="toggleMobileSearch();setBN('search')">
        <div class="bn-icon">üîç</div><div class="bn-label">Buscar</div>
      </div>
      <div class="bn-item" onclick="goTo('create');setBN('create')">
        <div class="bn-fab">+</div>
      </div>
      <div class="bn-item" id="bn-chat" onclick="goTo('chat');setBN('chat')">
        <div class="bn-icon">üí¨</div><div class="bn-label">Chat</div>
        <div class="bn-badge" id="bn-badge"></div>
      </div>
      <div class="bn-item" id="bn-dash" onclick="goTo('dashboard');setBN('dash')">
        <div class="bn-icon">üë§</div><div class="bn-label">Perfil</div>
      </div>
    </div>
  </nav>
</div>

<!-- EMOJI PICKER (simple) -->
<div class="modal-ov" id="emoji-modal">
  <div class="modal-box" style="max-height:300px;overflow-y:auto">
    <div class="modal-hd"><div class="modal-title">Emojis</div><button class="modal-close" onclick="closeModal('emoji-modal')">‚úï</button></div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:1.5rem">
      <span class="emo" onclick="addEmoji('üòä')">üòä</span><span class="emo" onclick="addEmoji('üòÇ')">üòÇ</span>
      <span class="emo" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="emo" onclick="addEmoji('üëç')">üëç</span>
      <span class="emo" onclick="addEmoji('üôè')">üôè</span><span class="emo" onclick="addEmoji('üî•')">üî•</span>
      <span class="emo" onclick="addEmoji('üíØ')">üíØ</span><span class="emo" onclick="addEmoji('‚úÖ')">‚úÖ</span>
      <span class="emo" onclick="addEmoji('ü§ù')">ü§ù</span><span class="emo" onclick="addEmoji('üí∞')">üí∞</span>
      <span class="emo" onclick="addEmoji('üì¶')">üì¶</span><span class="emo" onclick="addEmoji('üöö')">üöö</span>
      <span class="emo" onclick="addEmoji('üòç')">üòç</span><span class="emo" onclick="addEmoji('üéâ')">üéâ</span>
      <span class="emo" onclick="addEmoji('üëã')">üëã</span><span class="emo" onclick="addEmoji('üí¨')">üí¨</span>
    </div>
  </div>
</div>

<style>.emo{cursor:pointer;padding:4px;border-radius:6px;transition:background .15s;}.emo:hover{background:var(--sand);}</style>

<script>
// ============================================================
// SUPABASE CONFIG
// ============================================================
const SB_URL = 'https://fwacwpwdqkmykowxmffx.supabase.co';
const SB_KEY = 'sb_publishable_ci9XWHYXUqk01PZT5Jp0ug_VIrzP9cd';

let sb = null, user = null, currentProduct = null;
let basePrice = 0, baseCurr = 'MZN';
let selCatVal = '', uploadedPics = [], allProds = [];
let ratingSel = 0;
let currentConv = null, conversations = [], demoMsgs = {};
let pollInterval = null;

const RATES = {MZN:1,USD:.0157,EUR:.0144,ZAR:.283,GBP:.0124,BRL:.079,KES:2.03};
const CSYM = {MZN:'MT',USD:'$',EUR:'‚Ç¨',ZAR:'R',GBP:'¬£',BRL:'R$',KES:'KSh'};
const CATS = {eletronicos:'üì± Eletr√≥nicos',veiculos:'üöó Ve√≠culos',imoveis:'üè† Im√≥veis',roupas:'üëó Roupas',calcados:'üëü Cal√ßados',moveis:'üõãÔ∏è M√≥veis',eletrodomesticos:'üç≥ Eletrodom√©sticos',servicos:'üîß Servi√ßos',animais:'üêæ Animais',agricultura:'üåæ Agricultura',beleza:'üíÖ Beleza',criancas:'üß∏ Crian√ßas',desporto:'‚öΩ Desporto',musica:'üéµ M√∫sica',outros:'üì¶ Outros'};
const CATE = {eletronicos:'üì±',veiculos:'üöó',imoveis:'üè†',roupas:'üëó',calcados:'üëü',moveis:'üõãÔ∏è',eletrodomesticos:'üç≥',servicos:'üîß',animais:'üêæ',agricultura:'üåæ',beleza:'üíÖ',criancas:'üß∏',desporto:'‚öΩ',musica:'üéµ',outros:'üì¶'};

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', async () => {
  await new Promise(r => setTimeout(r, 1700));
  const loader = document.getElementById('loader');
  loader.classList.add('hide');
  setTimeout(() => loader.style.display='none', 500);

  // Always use Supabase
  try {
    sb = supabase.createClient(SB_URL, SB_KEY);
    const { data: { session } } = await sb.auth.getSession();
    if (session?.user) { 
      user = session.user; 
      await loadProfile(); 
      showApp(); 
    } else {
      showAuth();
    }
  } catch(e) { 
    console.error('Supabase init error:', e);
    toast('Erro ao conectar. Verifique sua conex√£o.', 'error');
    showAuth();
  }

  const isMobile = window.innerWidth <= 600;
  if (isMobile) {
    document.getElementById('mobile-search-bar').style.display = 'block';
  }
});

function showAuth() {
  document.getElementById('auth-page').style.display = 'block';
  document.getElementById('auth-page').classList.add('active');
  document.getElementById('main-app').style.display = 'none';
}
function showApp() {
  document.getElementById('auth-page').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  updateAvatar();
  goTo('home');
  loadProducts();
  loadConversations();
}

// ============================================================
// AUTH
// ============================================================
function authTab(t) {
  document.getElementById('tab-login').classList.toggle('active', t==='login');
  document.getElementById('tab-reg').classList.toggle('active', t==='register');
  document.getElementById('login-form').style.display = t==='login' ? 'block' : 'none';
  document.getElementById('reg-form').style.display = t==='register' ? 'block' : 'none';
  // On mobile, scroll card into view
  if (window.innerWidth < 900) {
    setTimeout(() => document.querySelector('.auth-card')?.scrollIntoView({behavior:'smooth', block:'nearest'}), 50);
  }
}

function togglePass(id, btn) {
  const inp = document.getElementById(id);
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'text' ? 'üôà' : 'üëÅÔ∏è';
}

function checkPassStrength(v) {
  const bar = document.getElementById('pass-strength');
  if (!v) { bar.style.display='none'; return; }
  bar.style.display = 'block';
  let score = 0;
  if (v.length >= 6) score++;
  if (v.length >= 10) score++;
  if (/[A-Z]/.test(v) || /[0-9]/.test(v)) score++;
  if (/[!@#$%^&*_\-]/.test(v)) score++;
  score = Math.max(1, score);
  const colors = ['#DC2626','#F97316','#EAB308','#22C55E'];
  const labels = ['Muito fraca üòü','Fraca üòï','Boa üëç','Forte üí™'];
  for (let i=1; i<=4; i++) {
    document.getElementById('sb'+i).style.background = i<=score ? colors[score-1] : 'var(--border)';
  }
  const lbl = document.getElementById('str-label');
  lbl.textContent = labels[score-1]||'';
  lbl.style.color = colors[score-1];
}

function updateRegProgress() {
  const name = document.getElementById('r-name')?.value||'';
  const email = document.getElementById('r-email')?.value||'';
  const pass = document.getElementById('r-pass')?.value||'';
  const score = (name.length>0?1:0) + (email.includes('@')?1:0) + (pass.length>=6?1:0);
  const stepColors = ['var(--border)','var(--border)','var(--border)'];
  for (let i=0; i<score; i++) stepColors[i] = i < score-1 ? 'var(--terra)' : 'var(--gold)';
  for (let i=1; i<=3; i++) {
    const el = document.getElementById('rs'+i);
    if (el) el.style.background = stepColors[i-1];
  }
}

function setLoginLoading(loading) {
  const btn = document.getElementById('btn-login');
  if (!btn) return;
  btn.textContent = loading ? '‚è≥ A entrar...' : 'Entrar na minha conta ‚Üí';
  btn.disabled = loading;
}

function setRegLoading(loading) {
  const btn = document.getElementById('btn-reg');
  if (!btn) return;
  btn.textContent = loading ? '‚è≥ A criar conta...' : 'Criar minha conta gr√°tis ‚Üí';
  btn.disabled = loading;
}

async function doLogin() {
  const email = document.getElementById('l-email').value.trim();
  const pass = document.getElementById('l-pass').value;
  const err = document.getElementById('login-err');
  err.classList.remove('show');
  
  if (!email||!pass) { 
    err.textContent='Preencha email e senha.'; 
    err.classList.add('show'); 
    return; 
  }
  
  if (!sb) {
    err.textContent='Erro de conex√£o. Recarregue a p√°gina.';
    err.classList.add('show');
    return;
  }
  
  setLoginLoading(true);
  
  try {
    const { data, error } = await sb.auth.signInWithPassword({email, password:pass});
    if (error) throw error;
    user = data.user; 
    await loadProfile(); 
    showApp();
    toast('‚úÖ Bem-vindo de volta!', 'success');
  } catch(e) {
    err.textContent = 'Email ou senha incorretos. Tente novamente.';
    err.classList.add('show');
  } finally { 
    setLoginLoading(false); 
  }
}

async function doRegister() {
  const name = document.getElementById('r-name').value.trim();
  const sname = document.getElementById('r-sname').value.trim();
  const email = document.getElementById('r-email').value.trim();
  const phone = document.getElementById('r-phone').value.trim();
  const city = document.getElementById('r-city').value;
  const pass = document.getElementById('r-pass').value;
  const err = document.getElementById('reg-err');
  err.classList.remove('show');
  
  if (!name) { 
    err.textContent='Introduza o seu nome.'; 
    err.classList.add('show'); 
    return; 
  }
  if (!email||!email.includes('@')) { 
    err.textContent='Introduza um email v√°lido.'; 
    err.classList.add('show'); 
    return; 
  }
  if (pass.length<6) { 
    err.textContent='A senha deve ter pelo menos 6 caracteres.'; 
    err.classList.add('show'); 
    return; 
  }
  
  if (!sb) {
    err.textContent='Erro de conex√£o. Recarregue a p√°gina.';
    err.classList.add('show');
    return;
  }
  
  setRegLoading(true);
  
  try {
    const fullName = (name+' '+sname).trim();
    // Sign up with Supabase - this will send email verification automatically if enabled
    const { data, error } = await sb.auth.signUp({
      email, 
      password:pass, 
      options:{
        data:{full_name:fullName, phone, city},
        emailRedirectTo: window.location.origin
      }
    });
    if (error) throw error;
    
    // Check if email confirmation is required
    if (data.user && !data.session) {
      // Email confirmation required - show OTP screen
      tempUserData = {userId: data.user.id, fullName, phone, city, email};
      showOTPScreen(email);
      setRegLoading(false);
      toast('üìß C√≥digo enviado para o seu email!', 'success');
    } else if (data.session) {
      // Auto-confirmed - proceed to app
      await sb.from('profiles').upsert({
        id:data.user.id, 
        full_name:fullName, 
        phone, 
        city, 
        email
      });
      user = data.user; 
      await loadProfile(); 
      showApp();
      toast('üéâ Conta criada! Bem-vindo ao Luvano!', 'success');
    }
  } catch(e) {
    err.textContent = e.message||'Erro ao criar conta. Tente novamente.';
    err.classList.add('show');
  } finally { 
    setRegLoading(false); 
  }
}

// ============================================================
// OTP VERIFICATION
// ============================================================
let tempUserData = null;
let otpCountdownTimer = null;
let otpTimeLeft = 60;

function showOTPScreen(email) {
  document.getElementById('reg-form').style.display = 'none';
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('otp-form').classList.add('active');
  document.getElementById('otp-email-display').textContent = email;
  
  // Setup OTP inputs
  const inputs = document.querySelectorAll('.otp-input');
  inputs.forEach((input, idx) => {
    input.value = '';
    input.classList.remove('filled', 'error');
    
    input.addEventListener('input', (e) => handleOTPInput(e, idx));
    input.addEventListener('keydown', (e) => handleOTPKeydown(e, idx));
    input.addEventListener('paste', handleOTPPaste);
  });
  
  // Focus first input
  setTimeout(() => inputs[0]?.focus(), 100);
  
  // Start countdown
  startOTPCountdown();
}

function handleOTPInput(e, idx) {
  const inputs = document.querySelectorAll('.otp-input');
  const input = e.target;
  const value = input.value.replace(/\D/g, ''); // Only numbers
  
  input.value = value;
  
  if (value) {
    input.classList.add('filled');
    // Auto-focus next input
    if (idx < inputs.length - 1) {
      inputs[idx + 1].focus();
    } else {
      // All filled - auto verify
      setTimeout(() => verifyOTP(), 200);
    }
  } else {
    input.classList.remove('filled');
  }
}

function handleOTPKeydown(e, idx) {
  const inputs = document.querySelectorAll('.otp-input');
  
  if (e.key === 'Backspace' && !e.target.value && idx > 0) {
    // Move to previous input on backspace if empty
    inputs[idx - 1].focus();
  } else if (e.key === 'ArrowLeft' && idx > 0) {
    inputs[idx - 1].focus();
  } else if (e.key === 'ArrowRight' && idx < inputs.length - 1) {
    inputs[idx + 1].focus();
  } else if (e.key === 'Enter') {
    verifyOTP();
  }
}

function handleOTPPaste(e) {
  e.preventDefault();
  const paste = (e.clipboardData || window.clipboardData).getData('text');
  const code = paste.replace(/\D/g, '').substring(0, 6);
  
  const inputs = document.querySelectorAll('.otp-input');
  code.split('').forEach((digit, idx) => {
    if (inputs[idx]) {
      inputs[idx].value = digit;
      inputs[idx].classList.add('filled');
    }
  });
  
  if (code.length === 6) {
    setTimeout(() => verifyOTP(), 300);
  }
}

function startOTPCountdown() {
  otpTimeLeft = 60;
  const timerEl = document.getElementById('otp-timer');
  const countdownEl = document.getElementById('otp-countdown');
  const resendBtn = document.getElementById('otp-resend-btn');
  
  timerEl.classList.add('active');
  resendBtn.disabled = true;
  
  clearInterval(otpCountdownTimer);
  otpCountdownTimer = setInterval(() => {
    otpTimeLeft--;
    countdownEl.textContent = otpTimeLeft;
    
    if (otpTimeLeft <= 0) {
      clearInterval(otpCountdownTimer);
      timerEl.classList.remove('active');
      timerEl.textContent = 'C√≥digo expirado';
      resendBtn.disabled = false;
    }
  }, 1000);
}

async function verifyOTP() {
  const inputs = document.querySelectorAll('.otp-input');
  const code = Array.from(inputs).map(i => i.value).join('');
  const err = document.getElementById('otp-err');
  const btn = document.getElementById('btn-verify');
  
  err.classList.remove('show');
  
  if (code.length !== 6) {
    err.textContent = 'Introduza todos os 6 d√≠gitos do c√≥digo.';
    err.classList.add('show');
    inputs.forEach(i => i.classList.add('error'));
    setTimeout(() => inputs.forEach(i => i.classList.remove('error')), 400);
    return;
  }
  
  btn.textContent = '‚è≥ A verificar...';
  btn.disabled = true;
  
  try {
    // Verify OTP with Supabase
    const { data, error } = await sb.auth.verifyOtp({
      email: tempUserData.email,
      token: code,
      type: 'signup'
    });
    
    if (error) throw error;
    
    if (data.session) {
      // OTP verified successfully
      clearInterval(otpCountdownTimer);
      
      // Create profile
      await sb.from('profiles').upsert({
        id: tempUserData.userId, 
        full_name: tempUserData.fullName, 
        phone: tempUserData.phone, 
        city: tempUserData.city, 
        email: tempUserData.email
      });
      
      user = data.user;
      await loadProfile();
      showApp();
      toast('üéâ Email verificado! Bem-vindo ao Luvano!', 'success');
    }
  } catch(e) {
    err.textContent = 'C√≥digo inv√°lido ou expirado. Tente novamente.';
    err.classList.add('show');
    inputs.forEach(i => {
      i.value = '';
      i.classList.remove('filled');
      i.classList.add('error');
    });
    setTimeout(() => {
      inputs.forEach(i => i.classList.remove('error'));
      inputs[0].focus();
    }, 400);
  } finally {
    btn.textContent = 'Verificar c√≥digo ‚Üí';
    btn.disabled = false;
  }
}

async function resendOTP() {
  const btn = document.getElementById('otp-resend-btn');
  const err = document.getElementById('otp-err');
  
  btn.disabled = true;
  btn.textContent = '‚è≥ A reenviar...';
  err.classList.remove('show');
  
  try {
    const { error } = await sb.auth.resend({
      type: 'signup',
      email: tempUserData.email
    });
    
    if (error) throw error;
    
    toast('üìß C√≥digo reenviado com sucesso!', 'success');
    startOTPCountdown();
    
    // Clear and focus first input
    const inputs = document.querySelectorAll('.otp-input');
    inputs.forEach(i => {
      i.value = '';
      i.classList.remove('filled', 'error');
    });
    inputs[0]?.focus();
    
  } catch(e) {
    err.textContent = 'Erro ao reenviar c√≥digo. Tente novamente.';
    err.classList.add('show');
  } finally {
    btn.textContent = '‚Üª Reenviar c√≥digo';
  }
}

function cancelOTP() {
  clearInterval(otpCountdownTimer);
  document.getElementById('otp-form').classList.remove('active');
  document.getElementById('reg-form').style.display = 'block';
  tempUserData = null;
  
  // Clear OTP inputs
  document.querySelectorAll('.otp-input').forEach(i => {
    i.value = '';
    i.classList.remove('filled', 'error');
  });
}

async function doLogout() {
  if (sb) await sb.auth.signOut();
  user = null; clearInterval(pollInterval);
  closeDD(); toast('üëã At√© logo!', 'info');
  setTimeout(showAuth, 400);
}

async function loadProfile() {
  if (!sb||!user) return;
  try {
    const {data} = await sb.from('profiles').select('*').eq('id',user.id).single();
    if (data) user.profile = data;
  } catch(e){}
}

function getUsername() { return user?.profile?.full_name||user?.user_metadata?.full_name||user?.email?.split('@')[0]||'Utilizador'; }
function getUserPhone() { return user?.profile?.phone||user?.user_metadata?.phone||''; }
function getUserCity() { return user?.profile?.city||user?.user_metadata?.city||''; }

function updateAvatar() {
  const n = getUsername();
  const a = n[0]?.toUpperCase()||'?';
  document.getElementById('nav-av').textContent = a;
}

// ============================================================
// NAV
// ============================================================
function goTo(page) {
  // Close any active page
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById(page+'-page');
  if (el) el.classList.add('active');
  window.scrollTo(0,0);
  if (page==='dashboard') loadDashboard();
  if (page==='home') loadProducts();
  if (page==='chat') { loadConversations(); setupMobileChat(); }
  closeDD();
}

function setBN(active) {
  document.querySelectorAll('.bn-item').forEach(el => el.classList.remove('active'));
  const id = {home:'bn-home',search:'bn-search',chat:'bn-chat',dash:'bn-dash'}[active];
  if (id) document.getElementById(id)?.classList.add('active');
}

let mobileSearchVisible = false;
function toggleMobileSearch() {
  const bar = document.getElementById('mobile-search-bar');
  mobileSearchVisible = !mobileSearchVisible;
  bar.style.display = mobileSearchVisible ? 'block' : 'none';
  if (mobileSearchVisible) bar.querySelector('input').focus();
}

function toggleDD() { document.getElementById('nav-dd').classList.toggle('open'); }
function closeDD() { document.getElementById('nav-dd').classList.remove('open'); }
document.addEventListener('click', e => { if (!e.target.closest('.nav-av-wrap')) closeDD(); });

// ============================================================
// PRODUCTS
// ============================================================
async function loadProducts(cat='all', search='') {
  const grid = document.getElementById('products-grid');
  grid.innerHTML = '<div class="no-items" style="grid-column:1/-1"><div class="ni-icon">‚è≥</div><h3>Carregando...</h3></div>';

  if (!sb) {
    grid.innerHTML = '<div class="no-items" style="grid-column:1/-1"><div class="ni-icon">‚ö†Ô∏è</div><h3>Erro de conex√£o</h3><p>Recarregue a p√°gina</p></div>';
    return;
  }
  
  try {
    let q = sb.from('products').select('*,profiles(full_name,city)').eq('active',true).order('created_at',{ascending:false});
    if (cat!=='all') q = q.eq('category',cat);
    if (search) q = q.ilike('title',`%${search}%`);
    const {data, error} = await q;
    if (error) throw error;
    allProds = data||[];
    renderProds(allProds);
    document.getElementById('st-listings').textContent = allProds.length;
  } catch(e) { 
    console.error('Load products error:', e);
    grid.innerHTML = '<div class="no-items" style="grid-column:1/-1"><div class="ni-icon">‚ö†Ô∏è</div><h3>Erro ao carregar an√∫ncios</h3><p>Tente novamente</p></div>';
  }
}

function renderProds(prods) {
  const grid = document.getElementById('products-grid');
  document.getElementById('st-listings').textContent = prods.length;
  if (!prods.length) {
    grid.innerHTML = `<div class="no-items" style="grid-column:1/-1">
      <div class="ni-icon">üîç</div><h3>Nenhum an√∫ncio encontrado</h3>
      <p>Seja o primeiro a publicar!</p><br>
      <button class="btn-main" style="width:auto;padding:11px 22px;font-size:.9rem;margin-top:8px" onclick="goTo('create')">Publicar An√∫ncio</button>
    </div>`; return;
  }
  grid.innerHTML = prods.map(p => {
    const img = p.images?.length ? `<img src="${p.images[0]}" alt="" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'pcard-placeholder\\'>${CATE[p.category]||'üì¶'}</div>'">` : `<div class="pcard-placeholder">${CATE[p.category]||'üì¶'}</div>`;
    const price = fmtPrice(p.price, p.currency);
    const loc = p.city||(p.profiles?.city)||'Mo√ßambique';
    const stars = mkStarsSmall(p.rating_avg||0);
    return `<div class="pcard" onclick="openProduct('${p.id}')">
      <div class="pcard-img">${img}
        <div class="pcard-badge">${p.condition||'Usado'}</div>
        <button class="pcard-fav" onclick="event.stopPropagation();toggleFav(this)">‚ô°</button>
      </div>
      <div class="pcard-body">
        <div class="pcard-title">${p.title}</div>
        <div class="pcard-price">${price}</div>
        <div class="pcard-foot">
          <span class="pcard-loc">üìç ${loc}</span>
          <span class="pcard-stars">${stars}<span class="pcard-rc">(${p.rating_count||0})</span></span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function mkStarsSmall(r) {
  return Array.from({length:5},(_,i) => `<span class="${i<Math.round(r)?'star-on':'star-off'}">‚òÖ</span>`).join('');
}

function fmtPrice(amt, curr='MZN') {
  const s = CSYM[curr]||curr;
  return `${s} ${Number(amt).toLocaleString('pt-MZ',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
}

function toggleFav(btn) {
  btn.classList.toggle('on');
  btn.textContent = btn.classList.contains('on') ? '‚ô•' : '‚ô°';
}

let searchTimer;
function doSearch(v) {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    const cat = document.querySelector('.cat-chip.active')?.onclick?.toString().match(/'([^']+)'/)?.[1]||'all';
    loadProducts(cat,v);
    document.getElementById('sec-label').textContent = v ? `üîç "${v}"` : '‚ú® An√∫ncios Recentes';
  }, 380);
}

function filterCat(cat, el) {
  document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const search = document.getElementById('search-inp').value;
  loadProducts(cat, search);
  document.getElementById('sec-label').textContent = cat==='all' ? '‚ú® An√∫ncios Recentes' : (CATS[cat]||cat);
}

// ============================================================
// PRODUCT DETAIL
// ============================================================
async function openProduct(id) {
  let p;
  if (!sb) p = allProds.find(x => x.id===id);
  else {
    try {
      const {data} = await sb.from('products').select('*,profiles(full_name,city,phone)').eq('id',id).single();
      p = data;
    } catch(e) { p = allProds.find(x => x.id===id); }
  }
  if (!p) return;
  currentProduct = p; basePrice = p.price; baseCurr = p.currency||'MZN';

  document.getElementById('d-cat').textContent = CATS[p.category]||p.category||'';
  document.getElementById('d-title').textContent = p.title;
  document.getElementById('d-price').textContent = fmtPrice(p.price, p.currency);
  document.getElementById('d-desc').textContent = p.description||'Sem descri√ß√£o.';
  document.getElementById('d-loc').innerHTML = `üìç ${[p.city,p.zone].filter(Boolean).join(' ‚Äî ')}`;
  document.getElementById('curr-sel').value = p.currency||'MZN';

  const avg = p.rating_avg||0;
  document.getElementById('d-stars').innerHTML = Array.from({length:5},(_,i)=>`<span style="color:${i<Math.round(avg)?'var(--gold)':'var(--border)'};font-size:1.1rem">‚òÖ</span>`).join('');
  document.getElementById('d-rate-txt').textContent = `${avg.toFixed(1)} (${p.rating_count||0})`;

  const sName = p.profiles?.full_name||p.seller_name||'Vendedor';
  document.getElementById('d-sav').textContent = sName[0]?.toUpperCase()||'?';
  document.getElementById('d-snm').textContent = sName;
  document.getElementById('d-sinfo').textContent = 'Membro desde '+new Date(p.created_at||Date.now()).getFullYear()+' ¬∑ Toque para enviar mensagem';

  // Images
  const imgs = p.images?.length ? p.images : [null];
  const mainEl = document.getElementById('det-main-img');
  mainEl.innerHTML = imgs[0] ? `<img src="${imgs[0]}" alt="" onerror="this.parentElement.innerHTML='<div class=\\'ph\\'>${CATE[p.category]||'üì¶'}</div>'">` : `<div class="ph">${CATE[p.category]||'üì¶'}</div>`;
  document.getElementById('det-thumbs').innerHTML = imgs.filter(Boolean).map((src,i) =>
    `<div class="thumb ${i===0?'on':''}" onclick="switchImg('${src}',this)"><img src="${src}" loading="lazy" alt=""></div>`
  ).join('');

  document.getElementById('btn-whatsapp-contact') && (document.getElementById('btn-whatsapp-contact').dataset.wa = p.whatsapp||p.profiles?.phone||'');
  currentProduct._wa = p.whatsapp||p.profiles?.phone||'';
  currentProduct._sellerName = sName;
  currentProduct._sellerId = p.user_id||'demo';

  goTo('detail');
  loadReviews(id);
  if (sb) sb.from('products').update({views:(p.views||0)+1}).eq('id',id).then(()=>{});
}

function switchImg(src, el) {
  document.getElementById('det-main-img').innerHTML = `<img src="${src}" alt="">`;
  document.querySelectorAll('.thumb').forEach(t => t.classList.remove('on'));
  el.classList.add('on');
}

function convertCurr() {
  const to = document.getElementById('curr-sel').value;
  const inMZN = basePrice/RATES[baseCurr];
  document.getElementById('d-price').textContent = fmtPrice(inMZN*RATES[to], to);
}

function contactWA() {
  const wa = (currentProduct?._wa||'').replace(/\D/g,'');
  if (!wa) { toast('N√∫mero WhatsApp n√£o dispon√≠vel','error'); return; }
  const msg = encodeURIComponent(`Ol√°! Vi o produto "${currentProduct?.title}" no Luvano. Ainda est√° dispon√≠vel?`);
  window.open(`https://wa.me/${wa}?text=${msg}`,'_blank');
}

function shareProduct() {
  const title = currentProduct?.title||'Luvano';
  if (navigator.share) navigator.share({title, url:location.href});
  else { navigator.clipboard.writeText(location.href); toast('üîó Link copiado!','success'); }
}

// ============================================================
// REVIEWS
// ============================================================
async function loadReviews(pid) {
  ratingSel = 0;
  document.querySelectorAll('.sbtn').forEach(s => s.classList.remove('on'));
  const list = document.getElementById('rev-list');
  list.innerHTML = '';

  if (!sb) {
    list.innerHTML = '<p style="color:var(--muted);font-size:.88rem">Erro ao carregar avalia√ß√µes.</p>';
    return;
  }

  try {
    const {data, error} = await sb.from('reviews').select('*,profiles(full_name)').eq('product_id',pid).order('created_at',{ascending:false});
    if (error) throw error;
    const reviews = data||[];
    
    if (!reviews.length) { 
      list.innerHTML = '<p style="color:var(--muted);font-size:.88rem">Ainda sem avalia√ß√µes. Seja o primeiro!</p>'; 
      return; 
    }
    
    list.innerHTML = reviews.map(r => {
      const nm = r.profiles?.full_name||r.reviewer_name||'Utilizador';
      const stars = Array.from({length:5},(_,i)=>`<span style="color:${i<r.rating?'var(--gold)':'var(--border)'}">‚òÖ</span>`).join('');
      const d = new Date(r.created_at).toLocaleDateString('pt-MZ');
      return `<div class="rev-item"><div class="rev-hd"><div class="rev-av">${nm[0]?.toUpperCase()}</div><div style="flex:1"><div class="rev-nm">${nm}</div><div class="rev-date">${d}</div></div><div class="rev-stars">${stars}</div></div><p class="rev-txt">${r.comment||''}</p></div>`;
    }).join('');
  } catch(e) {
    console.error('Load reviews error:', e);
    list.innerHTML = '<p style="color:var(--muted);font-size:.88rem">Erro ao carregar avalia√ß√µes.</p>';
  }
}

function setRat(v) {
  ratingSel = v;
  document.querySelectorAll('.sbtn').forEach((s,i) => s.classList.toggle('on', i<v));
}

async function submitRev() {
  if (!user) { toast('Fa√ßa login para avaliar','error'); return; }
  if (!ratingSel) { toast('Selecione de 1 a 5 estrelas','error'); return; }
  
  if (!sb) { toast('Erro de conex√£o','error'); return; }
  
  const comment = document.getElementById('rev-txt').value.trim();
  const rev = {
    product_id:currentProduct.id, 
    user_id:user.id, 
    reviewer_name:getUsername(), 
    rating:ratingSel, 
    comment, 
    created_at:new Date().toISOString()
  };
  
  try {
    await sb.from('reviews').insert(rev);
    const {data:revs} = await sb.from('reviews').select('rating').eq('product_id',currentProduct.id);
    const avg = revs.reduce((a,r)=>a+r.rating,0)/revs.length;
    await sb.from('products').update({rating_avg:avg,rating_count:revs.length}).eq('id',currentProduct.id);
    document.getElementById('rev-txt').value=''; 
    setRat(0);
    loadReviews(currentProduct.id); 
    toast('‚≠ê Avalia√ß√£o enviada!','success');
  } catch(e) { 
    console.error('Submit review error:', e);
    toast('Erro ao enviar avalia√ß√£o','error'); 
  }
}

// ============================================================
// CREATE LISTING
// ============================================================
function selCat(c, el) {
  selCatVal = c;
  document.querySelectorAll('.cato').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
}

function onPhotos(files) {
  for (const f of files) {
    if (uploadedPics.length>=8) { toast('M√°ximo 8 fotos','error'); break; }
    if (f.size>5*1024*1024) { toast(`${f.name} muito grande (m√°x 5MB)`,'error'); continue; }
    const r = new FileReader();
    r.onload = e => { uploadedPics.push({dataUrl:e.target.result,file:f}); updatePhPrev(); };
    r.readAsDataURL(f);
  }
}
function onDrop(e) { e.preventDefault(); document.getElementById('upload-z').classList.remove('drag'); onPhotos(e.dataTransfer.files); }
function onDragOver(e) { e.preventDefault(); document.getElementById('upload-z').classList.add('drag'); }

function updatePhPrev() {
  document.getElementById('photos-prev').innerHTML = uploadedPics.map((p,i) =>
    `<div class="ph-thumb"><img src="${p.dataUrl}"><button class="ph-rm" onclick="rmPhoto(${i})">‚úï</button></div>`
  ).join('');
}
function rmPhoto(i) { uploadedPics.splice(i,1); updatePhPrev(); }

async function submitListing() {
  const title = document.getElementById('c-title').value.trim();
  const desc = document.getElementById('c-desc').value.trim();
  const price = parseFloat(document.getElementById('c-price').value);
  const curr = document.getElementById('c-curr').value;
  const city = document.getElementById('c-city').value;
  const zone = document.getElementById('c-zone').value.trim();
  const wa = document.getElementById('c-wa').value.trim();
  const cond = document.getElementById('c-cond').value;

  if (!title) { toast('Adicione um t√≠tulo','error'); return; }
  if (!price||isNaN(price)) { toast('Adicione o pre√ßo','error'); return; }
  if (!selCatVal) { toast('Selecione uma categoria','error'); return; }
  if (!city) { toast('Selecione a cidade','error'); return; }
  
  if (!sb) { toast('Erro de conex√£o','error'); return; }

  const prod = {
    user_id:user?.id, 
    seller_name:getUsername(), 
    title, 
    description:desc, 
    price, 
    currency:curr, 
    category:selCatVal, 
    city, 
    zone, 
    whatsapp:wa, 
    condition:cond, 
    images:[], 
    rating_avg:0, 
    rating_count:0, 
    views:0, 
    active:true, 
    created_at:new Date().toISOString()
  };

  toast('üì§ A publicar an√∫ncio...', 'info');
  
  try {
    let imgUrls = [];
    for (const p of uploadedPics.slice(0,8)) {
      try {
        const ext = p.file.name.split('.').pop();
        const path = `products/${user.id}/${Date.now()}-${Math.random().toString(36).substr(2,9)}.${ext}`;
        const {error} = await sb.storage.from('product-images').upload(path,p.file);
        if (!error) { 
          const {data:url} = sb.storage.from('product-images').getPublicUrl(path); 
          imgUrls.push(url.publicUrl); 
        }
      } catch(e) { 
        console.error('Image upload error:', e);
      }
    }
    prod.images = imgUrls;
    const {error} = await sb.from('products').insert(prod);
    if (error) throw error;
    resetCreate(); await loadProducts(); goTo('home');
    toast('üéâ An√∫ncio publicado!','success');
  } catch(e) { toast('Erro: '+e.message,'error'); }
}

function resetCreate() {
  ['c-title','c-desc','c-price','c-zone','c-wa'].forEach(id => document.getElementById(id).value='');
  document.getElementById('c-city').value='';
  selCatVal=''; uploadedPics=[];
  updatePhPrev();
  document.querySelectorAll('.cato').forEach(o=>o.classList.remove('sel'));
}

// ============================================================
// CHAT SYSTEM
// ============================================================
let activeChatConv = null;

function loadConversations() {
  if (!sb) { 
    document.getElementById('conv-list').innerHTML = '<div class="conv-empty">Erro de conex√£o.</div>'; 
    return; 
  }
  
  sb.from('conversations')
    .select('*,messages(content,created_at,sender_id),products(title,price,currency,images)')
    .eq('buyer_id',user.id)
    .or(`seller_id.eq.${user.id}`)
    .order('updated_at',{ascending:false})
    .then(({data, error}) => { 
      if (error) throw error;
      conversations = data||[]; 
      renderConvList(conversations); 
    })
    .catch((e) => {
      console.error('Load conversations error:', e);
      renderConvList([]);
    });
}

function renderConvList(convs) {
  const list = document.getElementById('conv-list');
  if (!convs.length) { list.innerHTML = '<div class="conv-empty">Nenhuma conversa ainda.<br>Entre num an√∫ncio e envie uma mensagem!</div>'; return; }
  list.innerHTML = convs.map(c => {
    const isMe = c.buyer_id === (user?.id||'demo-user');
    const otherName = isMe ? (c.seller_name||'Vendedor') : (c.buyer_name||'Comprador');
    const lastMsg = c.last_message || c.messages?.slice(-1)[0]?.content || '...';
    const prodImg = c.product_img||(c.products?.images?.[0])||'';
    const unread = c.unread_count||0;
    const timeStr = c.updated_at ? timeAgo(new Date(c.updated_at)) : '';
    return `<div class="conv-item ${activeChatConv?.id===c.id?'active':''}" onclick="openConversation('${c.id}')">
      <div class="conv-av">${(otherName[0]||'?').toUpperCase()}</div>
      <div class="conv-info">
        <div class="conv-name">${otherName}</div>
        <div class="conv-preview">${c.product_title||c.products?.title||''} ‚Äî ${lastMsg}</div>
      </div>
      <div class="conv-meta">
        <span class="conv-time">${timeStr}</span>
        ${unread>0?`<div class="conv-unread">${unread}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

async function openConversation(convId) {
  const conv = [...conversations,...demoConvs].find(c=>c.id===convId);
  if (!conv) return;
  activeChatConv = conv;

  const isMe = conv.buyer_id===(user?.id||'demo-user');
  const otherName = isMe ? (conv.seller_name||'Vendedor') : (conv.buyer_name||'Comprador');

  document.getElementById('ch-av').textContent = (otherName[0]||'?').toUpperCase();
  document.getElementById('ch-name').textContent = otherName;

  // Product info
  const pName = conv.product_title||conv.products?.title||'';
  const pPrice = conv.product_price ? fmtPrice(conv.product_price, conv.product_currency||'MZN') : '';
  const pImg = conv.product_img||(conv.products?.images?.[0])||'';
  document.getElementById('chat-prod-name').textContent = pName;
  document.getElementById('chat-prod-price').textContent = pPrice;
  document.getElementById('chat-prod-img').innerHTML = pImg ? `<img src="${pImg}" alt="">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1.2rem">üì¶</div>`;
  document.getElementById('chat-prod-card').style.display = pName ? 'flex' : 'none';

  document.getElementById('chat-empty').style.display = 'none';
  document.getElementById('chat-active').style.display = 'flex';

  // Load messages
  await loadMessages(convId);
  setupMobileChat(true);
  renderConvList(conversations);

  // Poll for new messages
  clearInterval(pollInterval);
  pollInterval = setInterval(() => loadMessages(convId), 4000);
}

async function loadMessages(convId) {
  if (!sb) return;
  
  try {
    const {data, error} = await sb.from('messages').select('*').eq('conversation_id',convId).order('created_at',{ascending:true});
    if (error) throw error;
    const msgs = data||[];
    renderMessages(msgs);
    // mark as read
    if (activeChatConv) {
      sb.from('conversations').update({unread_count:0}).eq('id',convId).then(()=>{});
    }
  } catch(e){
    console.error('Load messages error:', e);
  }
}

function renderMessages(msgs) {
  const area = document.getElementById('msgs-area');
  const myId = user?.id;
  let lastDate = '';
  area.innerHTML = msgs.map(m => {
    const mine = m.sender_id === myId;
    const d = new Date(m.created_at).toLocaleDateString('pt-MZ');
    const t = new Date(m.created_at).toLocaleTimeString('pt-MZ',{hour:'2-digit',minute:'2-digit'});
    let dayBadge = '';
    if (d !== lastDate) { lastDate=d; dayBadge=`<div class="msg-day">${d}</div>`; }
    const init = mine ? (getUsername()[0]||'?').toUpperCase() : (m.sender_name||'?')[0].toUpperCase();
    return `${dayBadge}<div class="msg-row ${mine?'mine':'theirs'}">
      <div class="msg-av">${init}</div>
      <div>
        <div class="msg-bub">${escHtml(m.content)}</div>
        <div class="msg-time">${t}</div>
      </div>
    </div>`;
  }).join('');
  area.scrollTop = area.scrollHeight;
}

async function sendMsg() {
  const inp = document.getElementById('chat-inp');
  const content = inp.value.trim();
  if (!content||!activeChatConv) return;
  
  if (!sb) { toast('Erro de conex√£o','error'); return; }
  
  inp.value=''; 
  autoResize(inp);

  try {
    await sb.from('messages').insert({
      conversation_id:activeChatConv.id, 
      sender_id:user.id, 
      sender_name:getUsername(), 
      content
    });
    await sb.from('conversations').update({
      last_message:content, 
      updated_at:new Date().toISOString()
    }).eq('id',activeChatConv.id);
    loadMessages(activeChatConv.id);
  } catch(e) { 
    console.error('Send message error:', e);
    toast('Erro ao enviar mensagem','error'); 
  }
}

async function openSellerChat() {
  if (!currentProduct) return;
  if (!user) { toast('Fa√ßa login para enviar mensagem','error'); return; }
  if (!sb) { toast('Erro de conex√£o','error'); return; }
  
  const sellerId = currentProduct.user_id||currentProduct._sellerId;
  if (sellerId === user?.id) { toast('Este √© o seu pr√≥prio an√∫ncio','info'); return; }

  // Find or create conversation
  let conv = conversations.find(c =>
    (c.product_id===currentProduct.id) &&
    ((c.buyer_id===user.id && c.seller_id===sellerId) ||
     (c.seller_id===user.id && c.buyer_id===sellerId))
  );

  if (!conv) {
    const newConv = {
      product_id: currentProduct.id,
      product_title: currentProduct.title,
      product_price: currentProduct.price,
      product_currency: currentProduct.currency||'MZN',
      product_img: currentProduct.images?.[0]||'',
      buyer_id: user.id,
      buyer_name: getUsername(),
      seller_id: sellerId,
      seller_name: currentProduct._sellerName||currentProduct.seller_name||'Vendedor',
      last_message: '',
      unread_count: 0
    };
    
    try {
      const {data, error} = await sb.from('conversations').insert(newConv).select().single();
      if (error) throw error;
      conv = data;
      conversations.unshift(conv);
    } catch(e) { 
      console.error('Create conversation error:', e);
      toast('Erro ao criar conversa','error'); 
      return;
    }
  }

  goTo('chat');
  setTimeout(() => openConversation(conv.id), 100);
}

function viewChatProduct() {
  if (!activeChatConv?.product_id) return;
  const p = allProds.find(x=>x.id===activeChatConv.product_id);
  if (p) openProduct(p.id);
}

function chatWA() {
  const conv = activeChatConv;
  if (!conv) return;
  const isMe = conv.buyer_id===(user?.id||'demo-user');
  // Try to get WA from conv seller info
  const p = allProds.find(x=>x.id===conv.product_id);
  const wa = (p?.whatsapp||'').replace(/\D/g,'');
  if (!wa) { toast('N√∫mero WhatsApp n√£o dispon√≠vel','error'); return; }
  const msg = encodeURIComponent(`Ol√°! Estamos a conversar sobre "${conv.product_title}" no Luvano.`);
  window.open(`https://wa.me/${wa}?text=${msg}`,'_blank');
}

function filterConvs(v) {
  const all = [...conversations,...demoConvs];
  const filtered = v ? all.filter(c => (c.seller_name||'').toLowerCase().includes(v.toLowerCase()) || (c.buyer_name||'').toLowerCase().includes(v.toLowerCase()) || (c.product_title||'').toLowerCase().includes(v.toLowerCase())) : all;
  renderConvList(filtered);
}

// Mobile chat toggle
function setupMobileChat(showChat=false) {
  if (window.innerWidth > 900) return;
  const sidebar = document.getElementById('conv-sidebar');
  const chatWin = document.getElementById('chat-window');
  if (showChat) {
    sidebar.classList.add('show-chat');
    chatWin.classList.add('show-chat');
  } else {
    sidebar.classList.remove('show-chat');
    chatWin.classList.remove('show-chat');
  }
}

function closeChat() {
  clearInterval(pollInterval);
  activeChatConv = null;
  document.getElementById('chat-empty').style.display = 'flex';
  document.getElementById('chat-active').style.display = 'none';
  setupMobileChat(false);
  loadConversations();
}

function autoResize(el) {
  el.style.height='auto';
  el.style.height = Math.min(el.scrollHeight,100)+'px';
}

function insertEmoji() { openModal('emoji-modal'); }
function addEmoji(e) { const inp=document.getElementById('chat-inp'); inp.value+=e; inp.focus(); closeModal('emoji-modal'); }

// ============================================================
// DASHBOARD
// ============================================================
async function loadDashboard() {
  const n = getUsername();
  document.getElementById('dash-nm').textContent = n;
  document.getElementById('dash-em').textContent = user?.email||'';
  document.getElementById('dash-ph').textContent = getUserPhone();
  document.getElementById('dash-av').textContent = n[0]?.toUpperCase()||'?';
  document.getElementById('pf-name').value = n;
  document.getElementById('pf-city').value = getUserCity();
  document.getElementById('pf-phone').value = getUserPhone();

  const mine = allProds.filter(p=>p.user_id===user?.id);
  document.getElementById('ds-l').textContent = mine.length;
  document.getElementById('ds-v').textContent = mine.reduce((a,p)=>a+(p.views||0),0);

  if (sb) {
    try {
      const {data:myP, error} = await sb.from('products').select('*').eq('user_id',user.id);
      if (error) throw error;
      const mp = myP||[];
      document.getElementById('ds-l').textContent = mp.length;
      document.getElementById('ds-v').textContent = mp.reduce((a,p)=>a+(p.views||0),0);
      const {data:revs} = await sb.from('reviews').select('rating').in('product_id',mp.map(p=>p.id));
      document.getElementById('ds-r').textContent = (revs||[]).length;
      const avg = revs?.length ? (revs.reduce((a,r)=>a+r.rating,0)/revs.length).toFixed(1) : '-';
      document.getElementById('ds-rt').textContent = avg+(avg!=='-'?'‚òÖ':'');
      renderMyListings(mp);
      return;
    } catch(e){
      console.error('Load dashboard error:', e);
    }
  }
  renderMyListings(mine);
}

function renderMyListings(prods) {
  const el = document.getElementById('my-listings');
  if (!prods.length) {
    el.innerHTML=`<div class="dash-empty"><div class="de-icon">üì¶</div><h3 style="font-family:'Syne',sans-serif">Ainda sem an√∫ncios</h3><p style="color:var(--muted);font-size:.88rem">Publique o seu primeiro produto!</p><br><button class="btn-main" style="width:auto;padding:11px 22px;font-size:.9rem;margin-top:8px" onclick="goTo('create')">Publicar</button></div>`;
    return;
  }
  el.innerHTML = prods.map(p => {
    const img = p.images?.[0] ? `<img src="${p.images[0]}" onerror="this.src=''" alt="">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1.4rem">${CATE[p.category]||'üì¶'}</div>`;
    return `<div class="listing-row" onclick="openProduct('${p.id}')">
      <div class="lr-img">${img}</div>
      <div style="flex:1;min-width:0"><div class="lr-title">${p.title}</div><div class="lr-price">${fmtPrice(p.price,p.currency)}</div></div>
      <div class="lr-acts">
        <button class="icon-btn" onclick="event.stopPropagation();openProduct('${p.id}')" title="Ver">üëÅÔ∏è</button>
        <button class="icon-btn del" onclick="event.stopPropagation();deleteListing('${p.id}')" title="Eliminar">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

async function deleteListing(id) {
  if (!confirm('Eliminar este an√∫ncio?')) return;
  if (!sb) { toast('Erro de conex√£o','error'); return; }
  
  try { 
    const {error} = await sb.from('products').delete().eq('id',id); 
    if (error) throw error;
    toast('‚úÖ An√∫ncio eliminado','info');
    loadDashboard(); 
  } catch(e){ 
    console.error('Delete listing error:', e);
    toast('Erro ao eliminar','error'); 
  }
}

async function saveProfile() {
  const name = document.getElementById('pf-name').value.trim();
  const city = document.getElementById('pf-city').value.trim();
  const phone = document.getElementById('pf-phone').value.trim();
  
  if (!sb) { toast('Erro de conex√£o','error'); return; }
  
  try {
    await sb.from('profiles').upsert({id:user.id,full_name:name,city,phone});
    await sb.auth.updateUser({data:{full_name:name,city,phone}});
    if (!user.profile) user.profile={};
    Object.assign(user.profile,{full_name:name,city,phone});
    updateAvatar(); loadDashboard(); toast('‚úÖ Perfil guardado!','success');
  } catch(e){ toast('Erro ao guardar','error'); }
}

// ============================================================
// MODAL
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.addEventListener('click', e => { if (e.target.classList.contains('modal-ov')) e.target.classList.remove('open'); });

// ============================================================
// TOAST
// ============================================================
let toastT;
function toast(msg, type='info', dur=3500) {
  const el = document.getElementById('toast');
  el.textContent=msg; el.className=`toast ${type} show`;
  clearTimeout(toastT); toastT=setTimeout(()=>el.classList.remove('show'),dur);
}

// ============================================================
// UTILS
// ============================================================
function escHtml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function timeAgo(d) {
  const diff = Math.floor((Date.now()-d)/1000);
  if (diff<60) return 'agora'; if (diff<3600) return Math.floor(diff/60)+'min';
  if (diff<86400) return Math.floor(diff/3600)+'h'; return d.toLocaleDateString('pt-MZ');
}

// ============================================================
// HELPERS
// ============================================================

function updateMsgBadge(count) {
  const nb = document.getElementById('nav-badge');
  const bb = document.getElementById('bn-badge');
  if (count > 0) { 
    nb.textContent=count>9?'9+':count; 
    nb.classList.add('show'); 
    bb.textContent=count>9?'9+':count; 
    bb.classList.add('show'); 
  } else { 
    nb.classList.remove('show'); 
    bb.classList.remove('show'); 
  }
}
</script>

<!--
========================================
SUPABASE SQL SCHEMA ‚Äî Execute no Supabase SQL Editor
========================================

IMPORTANTE: Configurar verifica√ß√£o de email
-------------------------------------------
1. V√° em Authentication > Email Templates no painel do Supabase
2. Personalize o template "Confirm signup" com o c√≥digo OTP
3. Em Authentication > Settings > Auth Providers
4. Ative "Enable email confirmations" - isso enviar√° automaticamente
   um c√≥digo de 6 d√≠gitos para o email do usu√°rio no signup
5. Defina "Confirmation URL" como: {{.SiteURL}}
6. O c√≥digo expira em 60 segundos por padr√£o (configur√°vel)

SQL Schema:
-----------

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  full_name TEXT, email TEXT, phone TEXT, city TEXT,
  avatar_url TEXT, created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE products (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  seller_name TEXT, title TEXT NOT NULL,
  description TEXT, price DECIMAL(12,2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'MZN', category VARCHAR(50),
  city TEXT, zone TEXT, whatsapp TEXT,
  condition VARCHAR(30), images TEXT[],
  rating_avg DECIMAL(3,2) DEFAULT 0,
  rating_count INTEGER DEFAULT 0,
  views INTEGER DEFAULT 0, active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE conversations (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  product_id UUID REFERENCES products,
  product_title TEXT, product_price DECIMAL(12,2),
  product_currency VARCHAR(10), product_img TEXT,
  buyer_id UUID REFERENCES auth.users,
  buyer_name TEXT, seller_id UUID REFERENCES auth.users,
  seller_name TEXT, last_message TEXT,
  unread_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE messages (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  conversation_id UUID REFERENCES conversations ON DELETE CASCADE,
  sender_id UUID REFERENCES auth.users,
  sender_name TEXT, content TEXT NOT NULL,
  read BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE reviews (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  product_id UUID REFERENCES products ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users,
  reviewer_name TEXT, rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  comment TEXT, created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public profiles" ON profiles FOR SELECT USING (true);
CREATE POLICY "Own profile update" ON profiles FOR UPDATE USING (auth.uid()=id);
CREATE POLICY "Own profile insert" ON profiles FOR INSERT WITH CHECK (auth.uid()=id);

CREATE POLICY "Public products" ON products FOR SELECT USING (active=true);
CREATE POLICY "Auth insert product" ON products FOR INSERT WITH CHECK (auth.uid()=user_id);
CREATE POLICY "Own product update" ON products FOR UPDATE USING (auth.uid()=user_id);
CREATE POLICY "Own product delete" ON products FOR DELETE USING (auth.uid()=user_id);

CREATE POLICY "Own conversations" ON conversations FOR SELECT USING (auth.uid()=buyer_id OR auth.uid()=seller_id);
CREATE POLICY "Auth create conv" ON conversations FOR INSERT WITH CHECK (auth.uid()=buyer_id);
CREATE POLICY "Conv participants update" ON conversations FOR UPDATE USING (auth.uid()=buyer_id OR auth.uid()=seller_id);

CREATE POLICY "Conv messages" ON messages FOR SELECT USING (
  EXISTS (SELECT 1 FROM conversations WHERE id=conversation_id AND (buyer_id=auth.uid() OR seller_id=auth.uid()))
);
CREATE POLICY "Auth send message" ON messages FOR INSERT WITH CHECK (auth.uid()=sender_id);

CREATE POLICY "Public reviews" ON reviews FOR SELECT USING (true);
CREATE POLICY "Auth insert review" ON reviews FOR INSERT WITH CHECK (auth.role()='authenticated');

-- Storage
INSERT INTO storage.buckets(id,name,public) VALUES('product-images','product-images',true);
CREATE POLICY "Public images" ON storage.objects FOR SELECT USING (bucket_id='product-images');
CREATE POLICY "Auth upload" ON storage.objects FOR INSERT WITH CHECK (bucket_id='product-images' AND auth.role()='authenticated');
-->
</body>
</html>
